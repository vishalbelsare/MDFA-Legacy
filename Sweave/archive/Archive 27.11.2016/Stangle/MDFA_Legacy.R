### R code from vignette source 'C:/wia_desktop/Projekte/2014/MDFA-Legacy/Sweave/Rnw/MDFA_Legacy.Rnw'
### Encoding: ISO8859-1

###################################################
### code chunk number 1: init
###################################################
# Load packages
rm(list=ls())
library(tseries)
library(xts)
# Parallel computing
#require(doParallel)
#cl <- makeCluster(7)
#registerDoParallel(cl)

# Specify hard-disk
disk_id<-"C"

# Set paths
path.main<-paste(disk_id,":\\wia_desktop\\Projekte\\2014\\MDFA-Legacy\\Sweave\\",sep="")
# Path to DFA-code: R-files are cut-and-pasted from DFA-book (they are identical)
path_DFA.pgm<-paste(path.main,"R\\I-DFA\\",sep="")
# Path to MDFA-code
path_MDFA.pgm<-paste(path.main,"R\\I-MDFA\\",sep="")
# Path to Latex-folder: all pdfs generated by the R-code are filed there
path.out<-paste(path.main,"Latex\\",sep="")
# Path to data 
path.dat<-paste(path.main,"Data\\",sep="")


###################################################
### code chunk number 2: dft
###################################################
per<-function(x,plot_T)
{
  len<-length(x)
  per<-0:(len/2)
  DFT<-per

  for (k in 0:(len/2))
  {
    cexp <- complex(arg=-(1:len)*2*pi*k/len)
    DFT[k+1]<-sum(cexp*x*sqrt(1/(2*pi*len)))
  }
  per<-abs(DFT)^2
  if (plot_T)
  {
    par(mfrow=c(2,1))
    plot(per,type="l",axes=F,xlab="Frequency",ylab="Periodogram",
    main="Periodogram")
    axis(1,at=1+0:6*len/12,labels=c("0","pi/6","2pi/6","3pi/6",
    "4pi/6","5pi/6","pi"))
    axis(2)
    box()
    plot(log(per),type="l",axes=F,xlab="Frequency",ylab="Log-periodogram",
    main="Log-periodogram")
    axis(1,at=1+0:6*len/12,labels=c("0","pi/6","2pi/6","3pi/6",
    "4pi/6","5pi/6","pi"))
    axis(2)
    box()
  }
  return(list(DFT=DFT,per=per))
}


###################################################
### code chunk number 3: dfa_ms
###################################################

# This function computes mean-square DFA-solutions
# L is the length of the MA filter,
# periodogram is the frequency weighting function in the DFA
# Gamma is the transferfunction of the symmetric filter (target) and
# Lag is the lag-parameter: Lag=0 implies real-time filtering, Lag=L/2
#     implies symmetric filter
# The function returns optimal coefficients as well as the transfer function of the
#     optimized real-time filter
dfa_ms<-function(L,periodogram,Lag,Gamma)
{

  K<-length(periodogram)-1
  X<-exp(-1.i*Lag*pi*(0:(K))/(K))*rep(1,K+1)*sqrt(periodogram)
  X_y<-exp(-1.i*Lag*pi*(0:(K))/(K))*rep(1,K+1)
  for (l in 2:L)          #l<-L<-21
  {
    X<-cbind(X,(cos((l-1-Lag)*pi*(0:(K))/(K))+
    1.i*sin((l-1-Lag)*pi*(0:(K))/(K)))*sqrt(periodogram))
    X_y<-cbind(X_y,(cos((l-1-Lag)*pi*(0:(K))/(K))+
    1.i*sin((l-1-Lag)*pi*(0:(K))/(K))))
  }
  xtx<-t(Re(X))%*%Re(X)+t(Im(X))%*%Im(X)
# MA-Filtercoefficients
  b<-as.vector(solve(xtx)%*%(t(Re(X_y))%*%(Gamma*periodogram)))
# Transferfunction
  trffkt<-1:(K+1)
  trffkt[1]<-sum(b)
  for (k in 1:(K))#k<-1
  {
    trffkt[k+1]<-(b%*%exp(1.i*k*(0:(length(b)-1))*pi/(K)))
  }
  return(list(b=b,trffkt=trffkt))
}



###################################################
### code chunk number 4: dfa_ms
###################################################
source(file=paste(path_DFA.pgm,"DFA_code.r",sep=""))


###################################################
### code chunk number 5: dfa_ms
###################################################
head(dfa_analytic)


###################################################
### code chunk number 6: dfa_ms
###################################################
set.seed(1)
len<-100
target<-arima.sim(list(ar=0.9),n=len)
explaining_2<-target+rnorm(len)
explaining<-cbind(target,explaining_2)
x<-cbind(target,explaining)
dimnames(x)[[2]]<-c("target","explaining 1","explaining 2")
head(x)


###################################################
### code chunk number 7: dfa_ms
###################################################
x<-cbind(x[,1],lag(x[,2:3],-1))
dimnames(x)[[2]]<-c("target","lagged explaining 1","lagged explaining 2")
head(x)


###################################################
### code chunk number 8: dfa_ms
###################################################
source(file=paste(path_MDFA.pgm,"DFT.r",sep=""))


###################################################
### code chunk number 9: dfa_ms
###################################################
spec_comp


###################################################
### code chunk number 10: dfa_ms
###################################################
source(file=paste(path_MDFA.pgm,"I-MDFA.r",sep=""))


###################################################
### code chunk number 11: dfa_ms
###################################################
head(mdfa_analytic)


###################################################
### code chunk number 12: dfa_ms
###################################################
weight_func<-matrix(1:6)
L<-2


###################################################
### code chunk number 13: dfa_ms
###################################################
K<-nrow(weight_func)-1
lambda<-0
Lag<-0
eta<-0
i1<-F
i2<-F
weight_constraint<-rep(1/(nrow(weight_func)-1),nrow(weight_func)-1)
lambda_cross<-lambda_decay<-lambda_smooth<-0
lin_eta<-F
shift_constraint<-rep(0,nrow(weight_func)-1)
grand_mean<-F
b0_H0<-NULL
c_eta<-F
weights_only<-F
weight_structure<-c(0,0)
white_noise<-F
synchronicity<-F
lag_mat<-matrix(rep(0:(L-1),nrow(weight_func)-1),nrow=L)


###################################################
### code chunk number 14: dfa_ms
###################################################
source(file=paste(path_MDFA.pgm,"control_default.r",sep=""))


###################################################
### code chunk number 15: exercise_dfa_ms_1
###################################################
# Generate series of length 2000
lenh<-2000
len<-120
# Specify the AR-coefficients
a_vec<-c(0.9,0,-0.9)
xh<-matrix(nrow=lenh,ncol=length(a_vec))
x<-matrix(nrow=len,ncol=length(a_vec))
yhat<-x
y<-x
# Generate series for each AR(1)-process
for (i in 1:length(a_vec))
{
# We want the same random-seed for each process  
  set.seed(10)
  xh[,i]<-arima.sim(list(ar=a_vec[i]),n=lenh)
}


###################################################
### code chunk number 16: exercise_dfa_ms_2
###################################################
# Extract 120 observations in the midddle of the longer series
x<-xh[lenh/2+(-len/2):((len/2)-1),]
# Compute the coefficients of the symmetric target filter
cutoff<-pi/6
# Order of approximation
ord<-1000
# Filter weights ideal trend (See DFA)
gamma<-c(cutoff/pi,(1/pi)*sin(cutoff*1:ord)/(1:ord))
# Compute the outputs yt of the (truncated) symmetric target filter
for (i in 1:length(a_vec))
{
  for (j in 1:120)
  {
    y[j,i]<-gamma[1:900]%*%xh[lenh/2+(-len/2)-1+(j:(j-899)),i]+
    gamma[2:900]%*%xh[lenh/2+(-len/2)+(j:(j+898)),i]
  }
}


###################################################
### code chunk number 17: exercise_dfa_ms_3
###################################################
plot_T<-F
periodogram<-matrix(ncol=3,nrow=len/2+1)
trffkt<-periodogram
perf_mat<-matrix(nrow=3,ncol=2)
dimnames(perf_mat)[[2]]<-c("Criterion Value","Mean-Square Sample Filter Error")
dimnames(perf_mat)[[1]]<-c("a1=0.9","a1=0","a1=-0.9")
# Filter length
L<-12
# Real-time design
Lag<-0
# Target ideal trend
Gamma<-c(1,(1:(len/2))<len/12)
b<-matrix(nrow=L,ncol=3)
# Compute real-time filters
for (i in 1:3)#i<-1
{
# Compute the periodogram based on the data (length 120)  
  periodogram[,i]<-per(x[,i],plot_T)$per
# Optimize filters
  filt<-dfa_ms(L,periodogram[,i],Lag,Gamma)
  trffkt[,i]<-filt$trffkt
  b[,i]<-filt$b
# Compute real-time outputs (we can use the longer series in order 
# to obtain estimates for time points t=1,...,11)
  for (j in 1:len)
    yhat[j,i]<-filt$b%*%xh[lenh/2+(-len/2)-1+j:(j-L+1),i]
}


###################################################
### code chunk number 18: exercise_dfa_ms_3
###################################################
for (i in 1:3)
{
# Compute criterion values
  perf_mat[i,1]<-(2*pi/length(Gamma))*abs(Gamma-trffkt[,i])^2%*%periodogram[,i]
}
perf_mat[,1]


###################################################
### code chunk number 19: exercise_dfa_ms_4
###################################################
# Compute time-domain MSE
mse<-apply(na.exclude((yhat-y))^2,2,mean)
perf_mat[,2]<-mse
perf_mat[,2]


###################################################
### code chunk number 20: z_dfa_ar1_output.pdf
###################################################
  library(Hmisc)
  require(xtable)
  #latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
  #center = "centering", file = "", floating = FALSE)
  xtable(perf_mat, dec = 1,digits=rep(3,dim(perf_mat)[2]+1),
  paste("Criterion values vs. sample (mean-square) filter errors",sep=""),
  label=paste("perf_mat",sep=""),
  center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 21: z_dfa_ar1_output.pdf
###################################################
file = paste("z_dfa_ar1_sym_output.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(3,1))
for (i in 1:3)   #i<-1
{
  ymin<-min(min(y[,i]),min(na.exclude(yhat)[,i]))
  ymax<-max(max(y[,i]),max(na.exclude(yhat)[,i]))
  ts.plot(yhat[,i],main=paste("Time-domain MSE = ",
  round(mse[i],3)," , Frequency-domain MSE = ",
  round(perf_mat[i,1],3),", a1 = ",a_vec[i],sep=""),col="blue",ylim=c(ymin,ymax),
  gpars=list(xlab="year", ylab=""))
  lines(y[,i],col="red")
  mtext("Real-time", side = 3, line = -1,at=len/2,col="blue")
  mtext("target", side = 3, line = -2,at=len/2,col="red")
}
dev.off()


###################################################
### code chunk number 22: z_dfa_ar1_output.pdf
###################################################
file = paste("z_dfa_ar1_sym_output", sep = "")
cat("\\begin{figure}[H]")
cat("\\begin{center}")
cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
cat("\\caption{Real-time filter output (blue) vs. targets (red) for a1=0.9 (top), a1=0 (middle) and a1=-0.9 (bottom)", sep = "")
cat("\\label{z_dfa_ar1_sym_output}}", sep = "")
cat("\\end{center}")
cat("\\end{figure}")


###################################################
### code chunk number 23: z_dfa_ar1_output.pdf
###################################################

omega_k<-pi*0:(len/2)/(len/2)
file = paste("z_dfa_ar1_amp_shift.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(2,2))
amp<-abs(trffkt)
shift<-Arg(trffkt)/omega_k
plot(amp[,1],type="l",main="Amplitude functions",
axes=F,xlab="Frequency",ylab="Amplitude",col="black",ylim=c(0,1))
lines(amp[,2],col="orange")
lines(amp[,3],col="green")
lines(Gamma,col="violet")
mtext("Amplitude a1=0.9", side = 3, line = -1,at=len/4,col="black")
mtext("Amplitude a1=0", side = 3, line = -2,at=len/4,col="orange")
mtext("Amplitude a1=-0.9", side = 3, line = -3,at=len/4,col="green")
mtext("Target", side = 3, line = -4,at=len/4,col="violet")
axis(1,at=c(0,1:6*len/12+1),labels=c("0","pi/6","2pi/6","3pi/6",
"4pi/6","5pi/6","pi"))
axis(2)
box()
plot(shift[,1],type="l",main="Time-shifts",
axes=F,xlab="Frequency",ylab="Shift",col="black",
ylim=c(0,max(na.exclude(shift[,3]))))
lines(shift[,2],col="orange")
lines(shift[,3],col="green")
lines(rep(0,len/2+1),col="violet")
mtext("Shift a1=0.9", side = 3, line = -1,at=len/4,col="black")
mtext("Shift a1=0", side = 3, line = -2,at=len/4,col="orange")
mtext("Shift a1=-0.9", side = 3, line = -3,at=len/4,col="green")
mtext("Target", side = 3, line = -4,at=len/4,col="violet")
axis(1,at=c(0,1:6*len/12+1),labels=c("0","pi/6","2pi/6","3pi/6",
"4pi/6","5pi/6","pi"))
axis(2)
box()
plot(periodogram[,1],type="l",main="Periodograms",
axes=F,xlab="Frequency",ylab="Periodogram",col="black",
ylim=c(0,max(periodogram[,3])/6))
lines(periodogram[,2],col="orange")
lines(periodogram[,3],col="green")
mtext("Periodogram a1=0.9", side = 3, line = -1,at=len/4,col="black")
mtext("Periodogram a1=0", side = 3, line = -2,at=len/4,col="orange")
mtext("Periodogram a1=-0.9", side = 3, line = -3,at=len/4,col="green")
axis(1,at=c(0,1:6*len/12+1),labels=c("0","pi/6","2pi/6","3pi/6",
"4pi/6","5pi/6","pi"))
axis(2)
box()
dev.off()


###################################################
### code chunk number 24: z_dfa_ar1_output.pdf
###################################################
file = paste("z_dfa_ar1_amp_shift.pdf", sep = "")
cat("\\begin{figure}[H]")
cat("\\begin{center}")
cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
cat("\\caption{Amplitude (top left), time-shifts (top-right) and periodograms (bottom left) for
a1=0.9 (black), a1=0 (orange) and a1=-0.9 (green)", sep = "")
cat("\\label{z_dfa_ar1_amp_shift}}", sep = "")
cat("\\end{center}")
cat("\\end{figure}")


###################################################
### code chunk number 25: dfa_ms
###################################################
dfa_ms


###################################################
### code chunk number 26: exercise_dfa_ms_4
###################################################
# Select the first process
i_process<-1
# Define the data-matrix:
# The first column must be the target series. 
# Columns 2,3,... are the explaining series. In a univariate setting
# target and explaining variable are identical
data_matrix<-cbind(x[,i_process],x[,i_process])
# Determine the in-sample period (fully in sample)
insample<-nrow(data_matrix)
# Compute the DFT by relying on the multivariate DFT-function: d=0 for stationary data (default settings)
weight_func<-spec_comp(insample, data_matrix, d)$weight_func 
# For this replication exercise we have to define a second DFT which is altered in frequency zero only 
weight_func_mod<-weight_func
# Frequency zero is scaled by sqrt(2) in order to be able to replicate DFA
weight_func_mod[1,]<-sqrt(2)*weight_func[1,]


###################################################
### code chunk number 27: exercise_dfa_ms_4
###################################################
# Source the default (MSE-) parameter settings
source(file=paste(path_MDFA.pgm,"control_default.r",sep=""))
# Estimate filter coefficients: original (unmodified) DFTs
mdfa_obj_original<-mdfa_analytic(K,L,lambda,weight_func,Lag,Gamma,eta,cutoff,i1,i2,weight_constraint,lambda_cross,lambda_decay,lambda_smooth,lin_eta,shift_constraint,grand_mean,b0_H0,c_eta,weights_only=F,weight_structure,white_noise,synchronicity,lag_mat)
# Estimate filter coefficients: modified DFTs (for replication purpose only)
mdfa_obj_mod<-mdfa_analytic(K,L,lambda,weight_func_mod,Lag,Gamma,eta,cutoff,i1,i2,weight_constraint,lambda_cross,lambda_decay,lambda_smooth,lin_eta,shift_constraint,grand_mean,b0_H0,c_eta,weights_only=F,weight_structure,white_noise,synchronicity,lag_mat)
# Filter coefficients: compare MDFA and previous DFA
b_mat<-cbind(mdfa_obj_original$b,mdfa_obj_mod$b,b[,i_process])
dimnames(b_mat)[[2]]<-c("MDFA original","MDFA modified","DFA")
dimnames(b_mat)[[1]]<-paste("lag ",0:(L-1),sep="")
b_mat


###################################################
### code chunk number 28: exercise_dfa_ms_4
###################################################
# Criterion value
criterion_mdfa<-mdfa_obj_original$rever  
# DFA-numbers are stored in perf_mat
crit_mdfa<-matrix(c(criterion_mdfa,perf_mat[i_process,1],perf_mat[i_process,2]),ncol=1)
dimnames(crit_mdfa)[[1]]<-c("MDFA criterion (original)","DFA criterion","sample MSE")
dimnames(crit_mdfa)[[2]]<-"MSE estimates"
t(round(crit_mdfa,3))


###################################################
### code chunk number 29: exercise_dfa_ms_4
###################################################
set.seed(12)
# Select the AR(1)-process with coefficient 0.9
i_process<-1
# Scaling of the idiosyncratic noise
scale_idiosyncratic<-0.1
eps<-rnorm(nrow(xh))
indicator<-xh[,i_process]+scale_idiosyncratic*eps
# Data: first column=target, second column=x, third column=shifted (leading) indicator
data_matrix<-cbind(xh[,i_process],xh[,i_process],c(indicator[2:nrow(xh)],NA))
dimnames(data_matrix)[[2]]<-c("target","x","leading indicator")
# Extract 120 observations from the long sample
data_matrix_120<-data_matrix[lenh/2+(-len/2):((len/2)-1),]
head(data_matrix_120)


###################################################
### code chunk number 30: exercise_dfa_ms_4
###################################################
# Fully in sample
insample<-nrow(data_matrix_120)
# d=0 for stationary series: see default settings
weight_func<-spec_comp(insample, data_matrix_120, d)$weight_func 


###################################################
### code chunk number 31: exercise_dfa_ms_4
###################################################
# Source the default (MSE-) parameter settings
source(file=paste(path_MDFA.pgm,"control_default.r",sep=""))
# Estimate filter coefficients
mdfa_obj<-mdfa_analytic(K,L,lambda,weight_func,Lag,Gamma,eta,cutoff,i1,i2,weight_constraint,lambda_cross,lambda_decay,lambda_smooth,lin_eta,shift_constraint,grand_mean,b0_H0,c_eta,weights_only=F,weight_structure,white_noise,synchronicity,lag_mat)
# Filter coefficients
b_mat<-mdfa_obj$b
dimnames(b_mat)[[2]]<-c("x","leading indicator")
dimnames(b_mat)[[1]]<-paste("Lag ",0:(L-1),sep="")#dim(b_mat)
head(b_mat)


###################################################
### code chunk number 32: exercise_dfa_ms_4
###################################################
# Criterion value
round(mdfa_obj$rever,3)


###################################################
### code chunk number 33: exercise_dfa_ms_4
###################################################
yhat_multivariate_leading_indicator<-rep(NA,len)
for (j in 1:len)
  yhat_multivariate_leading_indicator[j]<-sum(apply(b_mat*data_matrix[lenh/2+(-len/2)-1+j:(j-L+1),2:3],1,sum))


###################################################
### code chunk number 34: exercise_dfa_ms_4
###################################################
y_target_leading_indicator<-y[,i_process]
perf_mse<-matrix(c(mean(na.exclude((yhat_multivariate_leading_indicator-y_target_leading_indicator))^2),mean(na.exclude((yhat[,i_process]-y_target_leading_indicator))^2)),nrow=1)
dimnames(perf_mse)[[2]]<-c("bivariate MDFA","DFA")
dimnames(perf_mse)[[1]]<-"Sample MSE"
round(perf_mse,3)


###################################################
### code chunk number 35: z_mdfadfa_ar1_output.pdf
###################################################
file = paste("z_mdfadfa_ar1_sym_output.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
i<-1
ymin<-min(min(y[,i]),min(na.exclude(yhat)[,i]))
ymax<-max(max(y[,i]),max(na.exclude(yhat)[,i]))
ts.plot(yhat[,i],main=paste("Sample MSE MDFA: ",ylab="",
round(perf_mse[1],3),", DFA: ",round(perf_mse[2],3),sep=""),col="blue",ylim=c(ymin,ymax))
lines(y[,i],col="red")
lines(yhat_multivariate_leading_indicator,col="green")
mtext("DFA", side = 3, line = -2,at=len/2,col="blue")
mtext("target", side = 3, line = -1,at=len/2,col="red")
mtext("MDFA", side = 3, line = -3,at=len/2,col="green")
dev.off()


###################################################
### code chunk number 36: z_mdfadfa_ar1_output.pdf
###################################################
file = paste("z_mdfadfa_ar1_sym_output", sep = "")
cat("\\begin{figure}[H]")
cat("\\begin{center}")
cat("\\includegraphics[height=3in, width=6in]{", file, "}\n",sep = "")
cat("\\caption{Target (red) vs. DFA (blue) and bivariate MDFA (green) for the first process (a1=0.9)", sep = "")
cat("\\label{z_mdfadfa_ar1_sym_output}}", sep = "")
cat("\\end{center}")
cat("\\end{figure}")


###################################################
### code chunk number 37: exercise_dfa_ms_4
###################################################
# Inverse SNR: the variance of the standardized noise is one: we thus normalize by 
# the standard deviation of the data x (second column of the data matrix) 
scale_idiosyncratic_vec<-c(0,0.1,0.5,1,2)/sqrt(var(data_matrix_120[,2]))
# We select fractional leads: multiples of 0.25 
# A fractional lead of 0.25 corresponds roughly to a week on a monthly time scale
delta_vec<-0.25*0:4


###################################################
### code chunk number 38: exercise_dfa_ms_4
###################################################
# Initialize the performance matrix
lead_snr_mat<-matrix(ncol=length(scale_idiosyncratic_vec),nrow=length(delta_vec))
dimnames(lead_snr_mat)[[2]]<-paste("1/SNR=",sqrt(var(data_matrix_120[,1]))*scale_idiosyncratic_vec,paste="")
dimnames(lead_snr_mat)[[2]][1]<-paste("Univ. design: ",dimnames(lead_snr_mat)[[2]][1],sep="")
dimnames(lead_snr_mat)[[1]]<-paste("Shift ",delta_vec,paste="")
# Generate the idiosyncratic noise
set.seed(20)
eps<-rnorm(nrow(data_matrix_120))
# Loop over all combinations of leads and SNR-ratios
for (i in 1:length(scale_idiosyncratic_vec))#i<-1
{
  for (j in 1:length(delta_vec))#j<-1
  {
# Add the (suitably scaled) noise: no lead yet.    
    indicator<-data_matrix_120[,2]+scale_idiosyncratic_vec[i]*eps
# Overwrite the indicator column with the new time series
    data_matrix_120[,3]<-indicator
# Compute the DFTs (full in-sample, for stationary series d=0)
    insample<-nrow(data_matrix_120)
    weight_func<-spec_comp(insample, data_matrix_120, d)$weight_func
# Compute the discrete frequency-grid omega_k: from zero to pi
    omega_k<-(0:(nrow(weight_func)-1))*pi/(nrow(weight_func)-1)
# Introduce the fractional time-shift by rotation of the DFT of the indicator (last column)
    weight_func[,ncol(weight_func)]<-exp(-1.i*delta_vec[j]*omega_k)*weight_func[,ncol(weight_func)]
# If the idiosyncratic noise is zero, then we use a univariate design
  if (i==1)
     weight_func<-weight_func[,-2]
# Compute optimal filters and derive the (frequency-domain) MSE
    mdfa_obj<-mdfa_analytic(K,L,lambda,weight_func,Lag,Gamma,eta,cutoff,i1,i2,weight_constraint,lambda_cross,lambda_decay,lambda_smooth,lin_eta,shift_constraint,grand_mean,b0_H0,c_eta,weights_only=F,weight_structure,white_noise,synchronicity,lag_mat)
# Store the MSE
    lead_snr_mat[j,i]<-mdfa_obj$rever
  }
}


###################################################
### code chunk number 39: z_dfa_ar1_output.pdf
###################################################
  library(Hmisc)
  require(xtable)
  #latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
  #center = "centering", file = "", floating = FALSE)
  xtable(lead_snr_mat, dec = 1,digits=rep(3,dim(lead_snr_mat)[2]+1),
  paste("Effect of lead and of (inverse) signal-to-noise ratio on filter MSE",sep=""),
  label=paste("lead_snr_mat",sep=""),
  center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 40: Filter_revisions.Rnw:14-16
###################################################
US_GDP<-read.csv(paste(path.dat,"US_GDP.csv",sep=""),header=T)
US_GDP_wp<-read.csv(paste(path.dat,"US_GDP_wp.csv",sep=""),header=T,sep=";")


###################################################
### code chunk number 41: US_GDP
###################################################
  library(Hmisc)
  require(xtable)
  #latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
  #center = "centering", file = "", floating = FALSE)
  xtable(US_GDP,
  paste("US-GDP: yearly vintages starting in Q1 2009 and ending in Q1 2013",sep=""),
  label=paste("US_GDP",sep=""),
  center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 42: dfa_ms
###################################################
head(dfa_ms)
#head(mdfa_analytic)


###################################################
### code chunk number 43: Filter_revisions.Rnw:86-102
###################################################
# Generate series
set.seed(10)
len<-120
a_vec<-c(0.9,0,-0.9)
x<-matrix(nrow=len,ncol=3)
plot_T<-F
yhat<-x
periodogram<-matrix(ncol=3,nrow=len/2+1)
trffkt<-periodogram
# Generate series
for (i in 1:3)
{
  set.seed(10)
  x[,i]<-arima.sim(list(ar=a_vec[i]),n=len)
}
Gamma<-c(1,(1:(len/2))<len/12)


###################################################
### code chunk number 44: Filter_revisions.Rnw:105-124
###################################################
L<-13
yhat_Lag<-array(dim=c(len,3,L/2+2))
trffkt<-array(dim=c(len/2+1,3,L/2+2))
b<-array(dim=c(L,3,L/2+2))
# Compute real-time filters for Lag=,...,L/2 and for the above three AR-processes
for (i in 1:3)
{
  periodogram[,i]<-per(x[,i],plot_T)$per
  for (Lag in 0:((L/2)+1))
  {
# Optimize filters
    filt<-dfa_ms(L,periodogram[,i],Lag,Gamma)
    trffkt[,i,Lag+1]<-filt$trffkt
    b[,i,Lag+1]<-filt$b
# Compute outputs
    for (j in L:len)
      yhat_Lag[j,i,Lag+1]<-filt$b%*%x[j:(j-L+1),i]
  }
}


###################################################
### code chunk number 45: Filter_revisions.Rnw:127-192
###################################################
# Discrete frequency grid
omega_k<-pi*0:(len/2)/(len/2)
colo<-rainbow(L/2+2)
file = paste("z_dfa_ar1_amp_shift_Lag_0.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(2,2))
amp<-abs(trffkt)
shift<-Arg(trffkt)/omega_k
for (i in 2:2)
{
  ymin<-min(amp[,i,],na.rm=T)
  ymax<-max(amp[,i,],na.rm=T)
  plot(amp[,i,1],type="l",main=paste("Amplitude functions, a1 = ",a_vec[i],sep=""),
  axes=F,xlab="Frequency",ylab="Amplitude",col=colo[1],ylim=c(ymin,ymax))
  mtext("Lag=0", side = 3, line = -1,at=len/4,col=colo[1])
  for (j in 2:(L/2+2))
  {
    lines(amp[,i,j],col=colo[j])
    mtext(paste("Lag=",j-1,sep=""), side = 3, line = -j,at=len/4,col=colo[j])
  }
  axis(1,at=c(0,1:6*len/12+1),labels=c("0","pi/6","2pi/6","3pi/6",
  "4pi/6","5pi/6","pi"))
  axis(2)
  box()
  ymin<-min(shift[,i,],na.rm=T)
  ymax<-max(shift[,i,],na.rm=T)
  plot(shift[,i,1],type="l",main=paste("Time-Shifts, a1 = ",a_vec[i],sep=""),
  axes=F,xlab="Frequency",ylab="Shift",col=colo[1],ylim=c(ymin,ymax))
  mtext("Lag=0", side = 3, line = -1,at=len/4,col=colo[1])
  for (j in 2:(L/2+2))
  {
    lines(shift[,i,j],col=colo[j])
    mtext(paste("Lag=",j-1,sep=""), side = 3, line = -j,at=len/4,col=colo[j])
  }
  axis(1,at=c(0,1:6*len/12+1),labels=c("0","pi/6","2pi/6","3pi/6",
  "4pi/6","5pi/6","pi"))
  axis(2)
  box()
  ymin<-min(b[,i,],na.rm=T)
  ymax<-max(b[,i,],na.rm=T)
  plot(b[,i,1],col=colo[1],ylim=c(ymin,ymax),main=paste("Filter coefficients"),
  ylab="Output",xlab="lag",axes=F,typ="l")
  mtext("Lag=0", side = 3, line = -1,at=L/2,col=colo[1])
  for (j in 2:(L/2+2))
  {
    lines(b[,i,j],col=colo[j],type="l")
    mtext(paste("Lag=",j-1,sep=""), side = 3, line = -j,at=L/2,col=colo[j])
  }
  axis(1,at=1:L,labels=-1+1:L)
  axis(2)
  box()

  ymin<-min(yhat_Lag[,i,],na.rm=T)
  ymax<-max(yhat_Lag[,i,],na.rm=T)
  ts.plot(yhat_Lag[,i,1],col=colo[1],ylim=c(ymin,ymax),
  main=paste("Output series"),ylab="Output")
  mtext("Lag=0", side = 3, line = -1,at=len/2,col=colo[1])  
  for (j in 2:(L/2+2))
  {
    lines(yhat_Lag[,i,j],col=colo[j])
    mtext(paste("Lag=",j-1,sep=""), side = 3, line = -j,at=len/2,col=colo[j])
  }

}
dev.off()


###################################################
### code chunk number 46: z_dfa_ar1_amp_shift_Lag_0.pdf
###################################################
  file = paste("z_dfa_ar1_amp_shift_Lag_0.pdf", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (left) and time-shift (right) functions as a function of Lag (rainbow colors) for
  the white noise process (a1=0)", sep = "")
  cat("\\label{z_dfa_ar1_amp_shift_Lag_0}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 47: Filter_revisions.Rnw:235-247
###################################################
vintage<-array(dim=c(len,3,len))
# For each of the three AR(1)-processes We compute the vintage series
for (i in 1:3)
{
  for (j in L:len)#j<-L
  {
    vintage[(j-as.integer(L/2)):j,i,j]<-yhat_Lag[j,i,(as.integer(L/2)+1):1]
    vintage[1:(j-as.integer(L/2)-1),i,j]<-
    yhat_Lag[(as.integer(L/2)+1):(j-1),i,as.integer(L/2)+1]
  }
}
number_vint<-6


###################################################
### code chunk number 48: Filter_revisions.Rnw:250-255
###################################################
# We select the third DGP with a1=-0.9
i<-3
vintage_triangle<-vintage[,i,]
dimnames(vintage_triangle)[[2]]<-paste("Publ. ",1:len,sep="")
dimnames(vintage_triangle)[[1]]<-paste("Target ",1:len,sep="")


###################################################
### code chunk number 49: vintage_triangle
###################################################
  library(Hmisc)
  require(xtable)
  #latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
  #center = "centering", file = "", floating = FALSE)
  xtable(vintage_triangle[(len-number_vint):len,(len-number_vint):len], dec = 1,digits=rep(3,dim(vintage_triangle[(len-number_vint):len,(len-number_vint):len])[2]+1),
  paste("Last few vintages for the AR(1)-process with a1=-0.9: columns correspond to vintages and are indexed
  by corresponding publication dates; rows correspond to revisions of estimates for a fixed historical target date; diagonals correspond to releases",sep=""),
  label=paste("vintage_triangle",sep=""),
  center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 50: Filter_revisions.Rnw:298-316
###################################################
colo<-rainbow(len)
file = paste("z_vintages.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(3,1))
for (i in 1:3)
{
  ymin<-min(vintage[,i,],na.rm=T)
  ymax<-max(vintage[,i,],na.rm=T)
  ts.plot(vintage[,i,L],col=colo[1],ylim=c(ymin,ymax),
  main=paste("Tentacle plot: vintages and full revision sequence,
  a1 = ",a_vec[i],sep=""),ylab="Vintages")
  for (j in (L+1):len)
  {
    lines(vintage[,i,j],col=colo[j])
  }
  lines(vintage[,i,len],col="red",lwd=2)
}
dev.off()


###################################################
### code chunk number 51: z_vintages.pdf
###################################################
  file = paste("z_vintages.pdf", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Tentacle plot: full historical revision sequence for
  a1=0.9 (top), a1=0 (middle) and a1=-0.9 (bottom). Final release is emphasized in bold red", sep = "")
  cat("\\label{z_vintages}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 52: Filter_revisions.Rnw:332-357
###################################################
file = paste("z_vintages_2.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(2,1))
i<-2
ymin<-min(vintage[,i,],na.rm=T)
ymax<-max(vintage[,i,],na.rm=T)
ts.plot(vintage[,i,L],col=colo[1],ylim=c(ymin,ymax),
main="Vintages: full revision sequence and final release (black)",ylab="Vintages")
for (j in (L+1):len)
{
  lines(vintage[,i,j],col=colo[j])
}
lines(vintage[,i,len],col="black",lwd=2)
i<-2
ymin<-min(vintage[,i,],na.rm=T)
ymax<-max(vintage[,i,],na.rm=T)
ts.plot(vintage[,i,L],col=colo[1],ylim=c(ymin,ymax),
main="Vintages: full revision sequence and real-time initial release (black)",
ylab="Vintages")
for (j in (L+1):len)
{
  lines(vintage[,i,j],col=colo[j])
}
lines(yhat_Lag[,i,1],col="black",lty=1)
dev.off()


###################################################
### code chunk number 53: z_vintages_2.pdf
###################################################
  file = paste("z_vintages_2.pdf", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Vintages: full historical revision sequence in the case of the white noise process", sep = "")
  cat("\\label{z_vintages_2}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 54: Filter_revisions.Rnw:380-391
###################################################
set.seed(12)
# Select the AR(1)-process with coefficient 0.9
i_process<-2
# Scaling of the idiosyncratic noise
scale_idiosyncratic<-0.1
eps<-rnorm(nrow(x))
indicator<-x[,i_process]+scale_idiosyncratic*eps
# Data: first column=target, second column=x, third column=shifted (leading) indicator
data_matrix_120<-cbind(x[,i_process],x[,i_process],c(indicator[2:nrow(x)],indicator[nrow(x)]))
dimnames(data_matrix_120)[[2]]<-c("target","x","leading indicator")
head(data_matrix_120)


###################################################
### code chunk number 55: exercise_dfa_ms_4
###################################################
# Fully in sample
insample<-nrow(data_matrix_120)
# d=0 for stationary series: see default settings
weight_func<-spec_comp(insample, data_matrix_120, d)$weight_func


###################################################
### code chunk number 56: exercise_dfa_ms_4
###################################################
yhat_Lag_mdfa<-matrix(nrow=len,ncol=L/2+2)
# Source the default (MSE-) parameter settings
source(file=paste(path_MDFA.pgm,"control_default.r",sep=""))
# Estimate filter coefficients
for (Lag in 0:((L/2)))#Lag<-6  mdfa_obj$rever
{
  mdfa_obj<-mdfa_analytic(K,L,lambda,weight_func,Lag,Gamma,eta,cutoff,i1,i2,weight_constraint,lambda_cross,lambda_decay,lambda_smooth,lin_eta,shift_constraint,grand_mean,b0_H0,c_eta,weights_only=F,weight_structure,white_noise,synchronicity,lag_mat)
  print(paste("Lag=",Lag," Criterion=",round(mdfa_obj$rever,4),sep=""))
# Filter coefficients
  b_mat<-mdfa_obj$b
# Compute outputs
  for (j in L:len)
    yhat_Lag_mdfa[j,Lag+1]<-sum(apply(b_mat*data_matrix_120[j:(j-L+1),2:3],1,sum))
}


###################################################
### code chunk number 57: Filter_revisions.Rnw:420-428
###################################################
vintage_mdfa<-matrix(nrow=len,ncol=len)
# For each of the three AR(1)-processes We compute the vintage series
for (j in L:len)#j<-len
{
  vintage_mdfa[(j-as.integer(L/2)):j,j]<-yhat_Lag_mdfa[j,(as.integer(L/2)+1):1]
  vintage_mdfa[1:(j-as.integer(L/2)-1),j]<-
  yhat_Lag_mdfa[(as.integer(L/2)+1):(j-1),as.integer(L/2)+1]
}


###################################################
### code chunk number 58: Filter_revisions.Rnw:431-453
###################################################
file = paste("z_vintages_mdfa.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(2,1))
ymin<-min(vintage_mdfa,na.rm=T)
ymax<-max(vintage_mdfa,na.rm=T)
ts.plot(vintage_mdfa[,L],col=colo[1],ylim=c(ymin,ymax),
main="Vintages: full revision sequence and final release (black)",ylab="Vintages")
for (j in (L+1):len)
{
  lines(vintage_mdfa[,j],col=colo[j])
}
lines(vintage_mdfa[,len],col="black",lwd=2)
ymin<-min(vintage_mdfa,na.rm=T)
ymax<-max(vintage_mdfa,na.rm=T)
ts.plot(vintage_mdfa[,L],col=colo[1],ylim=c(ymin,ymax),
main="Vintages: full revision sequence and final release (black)",ylab="Vintages")
for (j in (L+1):len)
{
  lines(vintage_mdfa[,j],col=colo[j])
}
lines(yhat_Lag_mdfa[,1],col="black",lwd=1)
dev.off()


###################################################
### code chunk number 59: z_vintages_mdfa.pdf
###################################################
  file = paste("z_vintages_mdfa.pdf", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Vintages: full historical revision sequence in the case of the white noise process", sep = "")
  cat("\\label{z_vintages_mdfa}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 60: exercise_constraint
###################################################
# Filter length
L<-5
set.seed(1)
# The first three coefficients are random numbers
b<-rnorm(1:(L-2))
# Define the constants: the following are classical restrictions (amplitude is 1 and time shift is zero)
w<-1
s<-0
b<-c(b,(L-1-s)*w-(L-1:(L-2))%*%b,(2+s-L)*w+(L-2:(L-1))%*%b)


###################################################
### code chunk number 61: exercise_constraint
###################################################
# Level constraint
sum(b)-w
# time-shift constraint
sum(b*0:(L-1))/sum(b)-s


###################################################
### code chunk number 62: Constraints.Rnw:424-453
###################################################
# Generate series
#rm(list=ls())
set.seed(10)
len<-120
a_vec<-c(0.9,0,-0.9)
x<-matrix(nrow=len,ncol=3)
plot_T<-F
yhat<-x
periodogram<-matrix(ncol=3,nrow=len/2+1)
trffkt<-periodogram
# Generate series
for (i in 1:3)
{
  set.seed(10)
  x[,i]<-arima.sim(list(ar=a_vec[i]),n=len)
}
# Target
Gamma<-c(1,(1:(len/2))<len/12)
set.seed(12)
# Select the AR(1)-process with coefficient 0.9
i_process<-3
# Scaling of the idiosyncratic noise
scale_idiosyncratic<-0.1
eps<-rnorm(nrow(x))
indicator<-x[,i_process]+scale_idiosyncratic*eps
# Data: first column=target, second column=x, third column=shifted (leading) indicator
data_matrix_120<-cbind(x[,i_process],x[,i_process],c(indicator[2:nrow(x)],indicator[nrow(x)]))
dimnames(data_matrix_120)[[2]]<-c("target","x","leading indicator")
head(data_matrix_120)


###################################################
### code chunk number 63: exercise_mdfa_ms_1
###################################################
# Filter length
L<-13
# Fully in sample
insample<-nrow(data_matrix_120)
# d=0 for stationary series: see default settings
weight_func<-spec_comp(insample, data_matrix_120, d)$weight_func
# Source the default (MSE-) parameter settings
source(file=paste(path_MDFA.pgm,"control_default.r",sep=""))
# Source a convenient plot function
source(file=paste(path_MDFA.pgm,"mplot_func.r",sep=""))

# Estimate filter coefficients
mdfa_obj<-mdfa_analytic(K,L,lambda,weight_func,Lag,Gamma,eta,cutoff,i1,i2,weight_constraint,lambda_cross,lambda_decay,lambda_smooth,lin_eta,shift_constraint,grand_mean,b0_H0,c_eta,weights_only=F,weight_structure,white_noise,synchronicity,lag_mat)

file = paste("z_mdfa_ar1_amp_shift_Lag_0_iF_i2F.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)

par(mfrow = c(2, 1))
# amplitude functions
mplot <- abs(mdfa_obj$trffkt)
# x-axis
freq_axe <- rep(NA, K + 1)
freq_axe[1] <- 0
freq_axe[1 + (1 : 6) * K / 6] <- c(paste0(c("", 2 : 5), "pi/6"), "pi")
ax <- freq_axe
# colors, title and additional titles
insamp <- 1.e+90
colo <- NULL
plot_title <- "Amplitude Functions"
title_more <- colnames(x[, -1])
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
# time-shift
mplot <- Arg(t(sign(apply(mdfa_obj$b, 2, sum)) * t(mdfa_obj$trffkt))) /
      ((0 : (nrow(mdfa_obj$trffkt) - 1)) * pi / (nrow(mdfa_obj$trffkt) - 1))
# We use the exact formula for the time-shift in frequency zero
mplot[1, ] <- apply(mdfa_obj$b * ((0 : (L - 1))), 2, sum) / 
      apply(mdfa_obj$b, 2, sum)
plot_title <- "Time-Shift"
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
dev.off()


###################################################
### code chunk number 64: z_mdfa_ar1_amp_shift_Lag_0_iF_i2F.pdf
###################################################
  file = paste("z_mdfa_ar1_amp_shift_Lag_0_iF_i2F.pdf", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (top) and time-shift (bottom) functions: unconstrained i1=I2=F", sep = "")
  cat("\\label{z_mdfa_ar1_amp_shift_Lag_0_iF_i2F}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 65: exercise_dfa_ms_2
###################################################
# Source the default (MSE-) parameter settings
source(file=paste(path_MDFA.pgm,"control_default.r",sep=""))
# Impose level constraint
i1<-T
# Constraints: for series 1 and 2
weight_constraint<-c((1+sqrt(5))/2,-sqrt(2))

mdfa_obj<-mdfa_analytic(K,L,lambda,weight_func,Lag,Gamma,eta,cutoff,i1,i2,weight_constraint,lambda_cross,lambda_decay,lambda_smooth,lin_eta,shift_constraint,grand_mean,b0_H0,c_eta,weights_only=F,weight_structure,white_noise,synchronicity,lag_mat)

file = paste("z_mdfa_ar1_amp_shift_Lag_0_iT_i2F.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)

par(mfrow = c(2, 1))
# amplitude functions
mplot <- abs(mdfa_obj$trffkt)
# x-axis
freq_axe <- rep(NA, K + 1)
freq_axe[1] <- 0
freq_axe[1 + (1 : 6) * K / 6] <- c(paste0(c("", 2 : 5), "pi/6"), "pi")
ax <- freq_axe
# colors, title and additional titles
insamp <- 1.e+90
colo <- NULL
plot_title <- "Amplitude Functions"
title_more <- colnames(x[, -1])
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
# time-shift
mplot <- Arg(t(sign(apply(mdfa_obj$b, 2, sum)) * t(mdfa_obj$trffkt))) /
      ((0 : (nrow(mdfa_obj$trffkt) - 1)) * pi / (nrow(mdfa_obj$trffkt) - 1))
# We use the exact formula for the time-shift in frequency zero
mplot[1, ] <- apply(mdfa_obj$b*(0:(L-1)),2,sum)/apply(mdfa_obj$b, 2, sum)
plot_title <- "Time-Shift"
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
dev.off()
print(c("Level restrictions", round(apply(mdfa_obj$b,2,sum),4)))


###################################################
### code chunk number 66: z_mdfa_ar1_amp_shift_Lag_0_iT_i2F.pdf
###################################################
  file = paste("z_mdfa_ar1_amp_shift_Lag_0_iT_i2F.pdf", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (top) and time-shift (bottom) functions: i1=T,i2=F", sep = "")
  cat("\\label{z_mdfa_ar1_amp_shift_Lag_0_iT_i2F}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 67: exercise_dfa_ms_3
###################################################
# Source the default (MSE-) parameter settings
source(file=paste(path_MDFA.pgm,"control_default.r",sep=""))#b0_H0
# Estimate filter coefficients: note that i1<-F by sourcing the default parameters
i2<-T
shift_constraint<-c(exp(1),-pi)

mdfa_obj<-mdfa_analytic(K,L,lambda,weight_func,Lag,Gamma,eta,cutoff,i1,i2,weight_constraint,lambda_cross,lambda_decay,lambda_smooth,lin_eta,shift_constraint,grand_mean,b0_H0,c_eta,weights_only=F,weight_structure,white_noise,synchronicity,lag_mat)

file = paste("z_mdfa_ar1_amp_shift_Lag_0_iF_i2T.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)

par(mfrow = c(2, 1))
# amplitude functions
mplot <- abs(mdfa_obj$trffkt)
# x-axis
freq_axe <- rep(NA, K + 1)
freq_axe[1] <- 0
freq_axe[1 + (1 : 6) * K / 6] <- c(paste0(c("", 2 : 5), "pi/6"), "pi")
ax <- freq_axe
# colors, title and additional titles
insamp <- 1.e+90
colo <- NULL
plot_title <- "Amplitude Functions"
title_more <- colnames(x[, -1])
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
# time-shift
mplot <- Arg(t(sign(apply(mdfa_obj$b, 2, sum)) * t(mdfa_obj$trffkt))) /
      ((0 : (nrow(mdfa_obj$trffkt) - 1)) * pi / (nrow(mdfa_obj$trffkt) - 1))
# We use the exact formula for the time-shift in frequency zero
mplot[1, ] <- apply(mdfa_obj$b*(0:(L-1)),2,sum)/apply(mdfa_obj$b, 2, sum)
plot_title <- "Time-Shift"
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
dev.off()
print(c("Time-shift restrictions",round(apply(mdfa_obj$b*(0:(L-1)),2,sum)/apply(mdfa_obj$b, 2, sum),4)))


###################################################
### code chunk number 68: z_mdfa_ar1_amp_shift_Lag_0_iF_i2T.pdf
###################################################
  file = paste("z_mdfa_ar1_amp_shift_Lag_0_iF_i2T.pdf", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (top) and time-shift (bottom) functions: i1=F,i2=T", sep = "")
  cat("\\label{z_mdfa_ar1_amp_shift_Lag_0_iF_i2T}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 69: exercise_mdfa_ms_4
###################################################
# Source the default (MSE-) parameter settings
source(file=paste(path_MDFA.pgm,"control_default.r",sep=""))
# Impose both constraints
i1<-T
i2<-T
# Specify the constraints
weight_constraint<-c((1+sqrt(5))/2,-sqrt(2))
shift_constraint<-c(exp(1),-pi)

mdfa_obj<-mdfa_analytic(K,L,lambda,weight_func,Lag,Gamma,eta,cutoff,i1,i2,weight_constraint,lambda_cross,lambda_decay,lambda_smooth,lin_eta,shift_constraint,grand_mean,b0_H0,c_eta,weights_only=F,weight_structure,white_noise,synchronicity,lag_mat)

file = paste("z_mdfa_ar1_amp_shift_Lag_0_iT_i2T.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)

par(mfrow = c(2, 1))
# amplitude functions
mplot <- abs(mdfa_obj$trffkt)
# x-axis
freq_axe <- rep(NA, K + 1)
freq_axe[1] <- 0
freq_axe[1 + (1 : 6) * K / 6] <- c(paste0(c("", 2 : 5), "pi/6"), "pi")
ax <- freq_axe
# colors, title and additional titles
insamp <- 1.e+90
colo <- NULL
plot_title <- "Amplitude Functions"
title_more <- colnames(x[, -1])
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
# time-shift
mplot <- Arg(t(sign(apply(mdfa_obj$b, 2, sum)) * t(mdfa_obj$trffkt))) /
      ((0 : (nrow(mdfa_obj$trffkt) - 1)) * pi / (nrow(mdfa_obj$trffkt) - 1))
# We use the exact formula for the time-shift in frequency zero
mplot[1, ] <- apply(mdfa_obj$b*(0:(L-1)),2,sum)/apply(mdfa_obj$b, 2, sum)
plot_title <- "Time-Shift"
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
dev.off()
print(c("Level restrictions", round(apply(mdfa_obj$b,2,sum),4)))
print(c("Time-shift restrictions",round(apply(mdfa_obj$b*(Lag:(L-1+Lag)),2,sum)/apply(mdfa_obj$b, 2, sum),4)))


###################################################
### code chunk number 70: z_mdfa_ar1_amp_shift_Lag_0_iT_i2T.pdf
###################################################
  file = paste("z_mdfa_ar1_amp_shift_Lag_0_iT_i2T.pdf", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (top) and time-shift (bottom) functions: i1=i2=T", sep = "")
  cat("\\label{z_mdfa_ar1_amp_shift_Lag_0_iT_i2T}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 71: exercise_dfa_ms_3
###################################################
# Source the default (MSE-) parameter settings
source(file=paste(path_MDFA.pgm,"control_default.r",sep=""))#b0_H0
# Estimate filter coefficients: note that i1<-F by sourcing the default parameters
i2<-T
Lag<--2
shift_constraint<-c(0,2)

mdfa_obj<-mdfa_analytic(K,L,lambda,weight_func,Lag,Gamma,eta,cutoff,i1,i2,weight_constraint,lambda_cross,lambda_decay,lambda_smooth,lin_eta,shift_constraint,grand_mean,b0_H0,c_eta,weights_only=F,weight_structure,white_noise,synchronicity,lag_mat)

b_mat<-mdfa_obj$b
trffkt_mdfa<-mdfa_obj$trffkt

file = paste("z_mdfa_ar1_amp_shift_Lag_0_iF_i2T_Lag.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)

par(mfrow = c(2, 1))
# amplitude functions
mplot <- abs(mdfa_obj$trffkt)
# x-axis
freq_axe <- rep(NA, K + 1)
freq_axe[1] <- 0
freq_axe[1 + (1 : 6) * K / 6] <- c(paste0(c("", 2 : 5), "pi/6"), "pi")
ax <- freq_axe
# colors, title and additional titles
insamp <- 1.e+90
colo <- NULL
plot_title <- "Amplitude Functions"
title_more <- colnames(x[, -1])
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
# time-shift
mplot <- Arg(t(sign(apply(mdfa_obj$b, 2, sum)) * t(mdfa_obj$trffkt))) /
      ((0 : (nrow(mdfa_obj$trffkt) - 1)) * pi / (nrow(mdfa_obj$trffkt) - 1))
# We use the exact formula for the time-shift in frequency zero
mplot[1, ] <- apply(mdfa_obj$b*(0:(L-1)),2,sum)/apply(mdfa_obj$b, 2, sum)
plot_title <- "Time-Shift"
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
dev.off()
print(c("Time-shift restrictions",round(apply(mdfa_obj$b*(0:(L-1)),2,sum)/apply(mdfa_obj$b, 2, sum),4)))


###################################################
### code chunk number 72: z_mdfa_ar1_amp_shift_Lag_0_iF_i2T_Lag.pdf
###################################################
  file = paste("z_mdfa_ar1_amp_shift_Lag_0_iF_i2T_Lag.pdf", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (top) and time-shift (bottom) functions: i1=F,i2=T, Lag=-2", sep = "")
  cat("\\label{z_mdfa_ar1_amp_shift_Lag_0_iF_i2T_Lag}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 73: exercise_dfa_ms_4
###################################################
len_t<-100
# Generate two linear trends (the are shifted by a constant in order to be distinguishable)
trend_data<-cbind(1:len_t,0.5+1:len_t)
# Compute both output series: normalize by the inverse transferfunctions in frequency zero
yhat_multivariate<-cbind(rep(NA,len_t),rep(NA,len_t))
for (i in 1:ncol(yhat_multivariate))
  for (j in L:len_t)
#  The transfer function in frequency zero is a real number: R computes a complex number
#  with vanishing imaginary part. We have to extract the real part because otherwise the complex 
#  series would not be plotted... 
    yhat_multivariate[j,i]<-sum(b_mat[,i]*trend_data[j:(j-L+1),i])/Re(trffkt_mdfa[1,i])
mplot<-cbind(trend_data,yhat_multivariate)
dimnames(mplot)[[2]]<-c("Input 1","Input 2","Output 1","Output 2")
# Display the last observations
tail(mplot)


###################################################
### code chunk number 74: ATS.Rnw:308-309
###################################################
head(dfa_analytic)


###################################################
### code chunk number 75: ATS.Rnw:312-313
###################################################
tail(dfa_analytic)


###################################################
### code chunk number 76: ATS.Rnw:342-344
###################################################
source(file=paste(path_DFA.pgm,"functions_trilemma.r",sep=""))
source(file=paste(path_MDFA.pgm,"mplot_func.r",sep=""))


###################################################
### code chunk number 77: ATS.Rnw:348-365
###################################################
#rm(list=ls())
# Specify the processes: ar(1) with coefficients -0.9,0 and 0.9
a_vec<-c(0.9,0.,-0.9)
# Specify the lambdas
lambda_vec<-c(0,2^(0:7))
# Specify the fixed eta
eta_vec<-rep(0,length(lambda_vec))
# Specify filter length
L<-24
# Length of estimation sample
len<-120
# cutoff
cutoff<-pi/12
# Nowcast
Lag<-0
# No filter constraints
i1<-i2<-F


###################################################
### code chunk number 78: ATS.Rnw:367-378
###################################################
# Unscaled ATS-components: see below for an activation of this option
scaled_ATS<-F
# Generate a single realization of the processes
anzsim<-1
# Use periodogram
mba<-F
estim_MBA<-T
# Length of symmetric filter (will be used later)
L_sym<-1000
# Length of long data (for computing the target)
len1<-3000


###################################################
### code chunk number 79: ATS.Rnw:380-382
###################################################
# Proceed to estimation
for_sim_obj<-for_sim_out(a_vec,len1,len,cutoff,L,mba,estim_MBA,L_sym,Lag,i1,i2,scaled_ATS,lambda_vec,eta_vec,anzsim)


###################################################
### code chunk number 80: ATS.Rnw:384-398
###################################################
# Extract sample performances
# 1 ATS
ats_sym_T<-for_sim_obj$ats_sym
# 2 Curvature, Peak Correlation, ...
amp_shift_mat_sim<-for_sim_obj$amp_shift_mat_sim
# 3. Amplitude and time-shifts
amp_sim_per<-for_sim_obj$amp_sim_per
shift_sim_per<-for_sim_obj$shift_sim_per
# 4. Output series
xff_sim<-for_sim_obj$xff_sim
# 5. Peak correlation and Curvature
amp_shift_mat_sim_T<-for_sim_obj$amp_shift_mat_sim
dim_names<-for_sim_obj$dim_names
i_process<-1


###################################################
### code chunk number 81: print_tab_cor
###################################################
library(Hmisc)
require(xtable)
#latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
#center = "centering", file = "", floating = FALSE)
xtable(ats_sym_T[-1,,i_process,1], dec = 1,digits=6, caption = paste("ATS-Components as a function of lambda (eta=0 fixed)",sep=""),label=paste("ats_comp_dfa_T",sep=""),
center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 82: ATS.Rnw:418-443
###################################################
for (DGP in 1:length(a_vec))#DGP<-3
{
  file = paste("z_box_plot_amp_and_shift_cust_T_",DGP,".pdf", sep = "")
  pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
  par(mfrow=c(1,2))
  mplot<-amp_sim_per[,-1,DGP,1]
  dimnames(mplot)[[2]]<-paste("Amplitude (",lambda_vec,",",eta_vec,")",sep="")
  ax<-rep(NA,ncol(mplot))
  ax[1+(0:6)*((nrow(mplot)-1)/6)]<-c(0,"pi/6","2pi/6","3pi/6","4pi/6","5pi/6","pi")
  plot_title<-"Amplitude functions"
  insamp<-1.e+90
  title_more<-dimnames(mplot)[[2]]
  colo<-rainbow(ncol(mplot))
  mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
  mplot<-shift_sim_per[,-1,DGP,1]
  dimnames(mplot)[[2]]<-paste("Time-shifts (",lambda_vec,",",eta_vec,")",sep="")
  ax<-rep(NA,ncol(mplot))
  ax[1+(0:6)*((nrow(mplot)-1)/6)]<-c(0,"pi/6","2pi/6","3pi/6","4pi/6","5pi/6","pi")
  plot_title<-"Time-shifts"
  insamp<-1.e+90
  title_more<-dimnames(mplot)[[2]]
  colo<-rainbow(ncol(mplot))
  mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
  dev.off()
}


###################################################
### code chunk number 83: z_box_plot_amp_and_shift_cust_T_1.pdf
###################################################
  file = paste("z_box_plot_amp_and_shift_cust_T_1", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (left) and time-shift functions (right) as a function of lambda for fixed eta=0", sep = "")
  cat("\\label{z_box_plot_amp_and_shift_cust_T_1}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 84: ATS.Rnw:456-487
###################################################
# Plots
#colo<-c("red","blue")
# we select DFA-MSE (second series) and a customized 
series_vec<-2:(length(eta_vec)+1)#c(2,8)
for (ki in 1:length(a_vec)) #ki<-1  
{
file = paste("z_dfa_cust_ats_out_",ki,"_T.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
# extract all series from first realization (there is only one realization here)
  xf_per<-xff_sim[940:(940+len),,ki,1]#dim(xff_sim)
  dimnames(xf_per)[[2]]<-dim_names[[1]]
  anf<-1
  enf<-len
  sel<-1:dim(amp)[2]
  mplot<-scale(xf_per[,series_vec][anf:enf,])  #head(xf_per)
  plot(as.ts(mplot[,1]),type="l",axes=F,col="red",ylim=c(min(na.exclude(mplot)),
  max(na.exclude(mplot))),ylab="",xlab="",
  main=paste("MSE (red) vs. Customized",sep=""),lwd=1)
  mtext("MSE", side = 3, line = -1,at=(enf-anf)/2,col=colo[1])
  for (i in 2:length(series_vec))
  {
    lines(as.ts(mplot[,i]),col=colo[i],lwd=1)
    mtext(paste("Customized: ",dimnames(xf_per)[[2]][series_vec[i]],sep=""), side = 3, line = -i,at=(enf-anf)/2,col=colo[i])
  }
  axis(1,at=c(1,rep(0,6))+as.integer((0:6)*(enf-anf)/6),
  labels=as.integer(anf+(0:6)*(enf-anf)/6))
  axis(2)
  box()

dev.off()
}


###################################################
### code chunk number 85: z_dfa_cust_ats_out_1_T.pdf
###################################################
  file = paste("z_dfa_cust_ats_out_1_T", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Filter outputs: MSE (red) vs. customized , a1=0.9", sep = "")
  cat("\\label{z_dfa_cust_ats_out_1_T}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 86: ATS.Rnw:519-523
###################################################
# Specify the etas
eta_vec<-0.3*0:6
# Specify the fixed lambda
lambda_vec<-rep(0,length(eta_vec))


###################################################
### code chunk number 87: ATS.Rnw:525-548
###################################################
#rm(list=ls())
# Specify the processes: ar(1) with coefficients -0.9,0 and 0.9
a_vec<-c(0.9,0,-0.9)
# Ordinary ATS-components
scaled_ATS<-F
# Generate a single realization of the processes
anzsim<-1
# Specify filter length
L<-24
# Use periodogram
mba<-F
estim_MBA<-T
L_sym<-1000
# Length of long data (for computing the target)
len1<-3000
# Length of estimation sample
len<-120
# cutoff
cutoff<-pi/12
#
Lag<-0
#
i1<-i2<-F


###################################################
### code chunk number 88: ATS.Rnw:550-552
###################################################
# Proceed to estimation
for_sim_obj<-for_sim_out(a_vec,len1,len,cutoff,L,mba,estim_MBA,L_sym,Lag,i1,i2,scaled_ATS,lambda_vec,eta_vec,anzsim)


###################################################
### code chunk number 89: ATS.Rnw:554-570
###################################################
# Extract sample performances
# 1 ATS
ats_sym_S<-for_sim_obj$ats_sym
# 2 Curvature, Peak Correlation, ...
amp_shift_mat_sim<-for_sim_obj$amp_shift_mat_sim
# 3. Amplitude and time-shifts
amp_sim_per<-for_sim_obj$amp_sim_per
shift_sim_per<-for_sim_obj$shift_sim_per
# 4. Output series
xff_sim<-for_sim_obj$xff_sim
# 5. Peak correlation and Curvature
amp_shift_mat_sim_S<-for_sim_obj$amp_shift_mat_sim
# 6. Filter coefficients
b_sim<-for_sim_obj$b_sim
dim_names<-for_sim_obj$dim_names
i_process<-1


###################################################
### code chunk number 90: print_tab_cor
###################################################
library(Hmisc)
require(xtable)
#latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
#center = "centering", file = "", floating = FALSE)
xtable(ats_sym_S[-1,,i_process,1], dec = 1,digits=6, caption = paste("ATS-Components as a function of eta (lambda=0 fixed)",sep=""),label=paste("ats_comp_dfa_S",sep=""),
center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 91: ATS.Rnw:583-608
###################################################
for (DGP in 1:length(a_vec))#DGP<-1
{
  file = paste("z_box_plot_amp_and_shift_cust_S_",DGP,".pdf", sep = "")
  pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
  par(mfrow=c(1,2))
  mplot<-amp_sim_per[,-1,DGP,1]
  dimnames(mplot)[[2]]<-paste("Amplitude (",lambda_vec,",",eta_vec,")",sep="")
  ax<-rep(NA,ncol(mplot))
  ax[1+(0:6)*((nrow(mplot)-1)/6)]<-c(0,"pi/6","2pi/6","3pi/6","4pi/6","5pi/6","pi")
  plot_title<-"Amplitude functions"
  insamp<-1.e+90
  title_more<-dimnames(mplot)[[2]]
  colo<-rainbow(ncol(mplot))
  mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
  mplot<-shift_sim_per[,-1,DGP,1]
  dimnames(mplot)[[2]]<-paste("Time-shifts (",lambda_vec,",",eta_vec,")",sep="")
  ax<-rep(NA,ncol(mplot))
  ax[1+(0:6)*((nrow(mplot)-1)/6)]<-c(0,"pi/6","2pi/6","3pi/6","4pi/6","5pi/6","pi")
  plot_title<-"Time-shifts"
  insamp<-1.e+90
  title_more<-dimnames(mplot)[[2]]
  colo<-rainbow(ncol(mplot))
  mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
  dev.off()
}


###################################################
### code chunk number 92: z_box_plot_amp_and_shift_cust_S_1.pdf
###################################################
  file = paste("z_box_plot_amp_and_shift_cust_S_1", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (left) and time-shift functions (right) as a function of eta (lambda=0 fixed)", sep = "")
  cat("\\label{z_box_plot_amp_and_shift_cust_S_1}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 93: ATS.Rnw:621-634
###################################################
for (DGP in 1:length(a_vec))#DGP<-1
{
  file = paste("z_box_plot_coef_S_",DGP,".pdf", sep = "")
  pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
  mplot<-b_sim[,-1,DGP,1]
  ax<-dimnames(mplot)[[1]]
  plot_title<-"Filter coefficients"
  insamp<-1.e+90
  title_more<-dimnames(mplot)[[2]]
  colo<-rainbow(ncol(mplot))
  mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
  dev.off()
}


###################################################
### code chunk number 94: z_box_plot_coef_S_1.pdf
###################################################
  file = paste("z_box_plot_coef_S_1", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=4in]{", file, "}\n",sep = "")
  cat("\\caption{Filter coefficients as a function of eta (lambda=0 fixed)", sep = "")
  cat("\\label{z_box_plot_coef_S_1}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 95: ATS.Rnw:647-677
###################################################
# Plots
#colo<-c("red","blue")
# we select DFA-MSE (second series) and a customized 
series_vec<-2:length(eta_vec)
for (ki in 1:length(a_vec)) #ki<-1  
{
file = paste("z_dfa_cust_ats_out_",ki,"_S.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
# extract all series from first realization (there is only one realization here)
  xf_per<-xff_sim[940:(940+len),,ki,1]#dim(xff_sim)
  dimnames(xf_per)[[2]]<-dim_names[[1]]
  anf<-1
  enf<-len
  sel<-1:dim(amp)[2]
  mplot<-scale(xf_per[,series_vec][anf:enf,])  #head(xf_per)
  plot(as.ts(mplot[,1]),type="l",axes=F,col="red",ylim=c(min(na.exclude(mplot)),
  max(na.exclude(mplot))),ylab="",xlab="",
  main=paste("MSE (red) vs. Customized",sep=""),lwd=1)
  mtext("MSE", side = 3, line = -1,at=(enf-anf)/2,col=colo[1])
  for (i in 2:length(series_vec))
  {
    lines(as.ts(mplot[,i]),col=colo[i],lwd=1)
    mtext(paste("Customized: ",dimnames(xf_per)[[2]][series_vec[i]],sep=""), side = 3, line = -i,at=(enf-anf)/2,col=colo[i])
  }
  axis(1,at=c(1,rep(0,6))+as.integer((0:6)*(enf-anf)/6),
  labels=as.integer(anf+(0:6)*(enf-anf)/6))
  axis(2)
  box()
dev.off()
}


###################################################
### code chunk number 96: z_dfa_cust_ats_out_1_S.pdf
###################################################
  file = paste("z_dfa_cust_ats_out_1_S", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=4in]{", file, "}\n",sep = "")
  cat("\\caption{Filter outputs MSE (red) vs. customized, a1=0.9", sep = "")
  cat("\\label{z_dfa_cust_ats_out_1_S}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 97: ATS.Rnw:711-715
###################################################
# Specify the etas
eta_vec<-c(0,1.8)
# Specify the fixed lambda
lambda_vec<-c(0,128)


###################################################
### code chunk number 98: ATS.Rnw:717-740
###################################################
#rm(list=ls())
# Specify the processes: ar(1) with coefficients -0.9,0 and 0.9
a_vec<-c(0.9,0,-0.9)
# Ordinary ATS-components
scaled_ATS<-F
# Generate a single realization of the processes
anzsim<-1
# Specify filter length
L<-24
# Use periodogram
mba<-F
estim_MBA<-T
L_sym<-1000
# Length of long data (for computing the target)
len1<-3000
# Length of estimation sample
len<-120
# cutoff
cutoff<-pi/12
#
Lag<-0
#
i1<-i2<-F


###################################################
### code chunk number 99: ATS.Rnw:742-744
###################################################
# Proceed to estimation
for_sim_obj<-for_sim_out(a_vec,len1,len,cutoff,L,mba,estim_MBA,L_sym,Lag,i1,i2,scaled_ATS,lambda_vec,eta_vec,anzsim)


###################################################
### code chunk number 100: ATS.Rnw:746-760
###################################################
# Extract sample performances
# 1 ATS
ats_sym_ST<-for_sim_obj$ats_sym
# 2 Curvature, Peak Correlation, ...
amp_shift_mat_sim<-for_sim_obj$amp_shift_mat_sim
# 3. Amplitude and time-shifts
amp_sim_per<-for_sim_obj$amp_sim_per
shift_sim_per<-for_sim_obj$shift_sim_per
# 4. Output series
xff_sim<-for_sim_obj$xff_sim
# 5. Peak correlation and Curvature
amp_shift_mat_sim_ST<-for_sim_obj$amp_shift_mat_sim
dim_names<-for_sim_obj$dim_names
i_process<-1


###################################################
### code chunk number 101: print_tab_cor
###################################################
library(Hmisc)
require(xtable)
#latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
#center = "centering", file = "", floating = FALSE)
xtable(ats_sym_ST[-1,,i_process,1], dec = 1,digits=6, caption = paste("ATS-Components as a function of lambda and eta, a1=0.9",sep=""),label=paste("ats_comp_dfa_ST_1",sep=""),
center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 102: ATS.Rnw:775-802
###################################################

for (DGP in 1:length(a_vec))#DGP<-3
{
  file = paste("z_box_plot_amp_and_shift_cust_ST_",DGP,".pdf", sep = "")
  pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 3)
  par(mfrow=c(1,2))
  mplot<-amp_sim_per[,-1,DGP,1]
  dimnames(mplot)[[2]]<-paste("Amplitude (",lambda_vec,",",eta_vec,")",sep="")
  ax<-rep(NA,ncol(mplot))
  ax[1+(0:6)*((nrow(mplot)-1)/6)]<-c(0,"pi/6","2pi/6","3pi/6","4pi/6","5pi/6","pi")
  plot_title<-paste("Amplitude functions: a1=",a_vec[DGP],sep="")
  insamp<-1.e+90
  title_more<-dimnames(mplot)[[2]]
  colo<-rainbow(ncol(mplot))
  mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
  mplot<-shift_sim_per[,-1,DGP,1]
  dimnames(mplot)[[2]]<-paste("Time-shifts (",lambda_vec,",",eta_vec,")",sep="")
  ax<-rep(NA,ncol(mplot))
  ax[1+(0:6)*((nrow(mplot)-1)/6)]<-c(0,"pi/6","2pi/6","3pi/6","4pi/6","5pi/6","pi")
  plot_title<-paste("Time-shifts: a1=",a_vec[DGP],sep="")
  insamp<-1.e+90
  title_more<-dimnames(mplot)[[2]]
  colo<-rainbow(ncol(mplot))
  mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
  dev.off()
}



###################################################
### code chunk number 103: z_box_plot_amp_and_shift_cust_ST_1.pdf
###################################################
  file = paste("z_box_plot_amp_and_shift_cust_ST_1", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=4in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (left) and time-shift functions (right) as a function of lambda and eta", sep = "")
  cat("\\label{z_box_plot_amp_and_shift_cust_ST_1}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 104: ATS.Rnw:815-844
###################################################
# Plots
#colo<-c("red","blue")
# we select DFA-MSE (second series) and a customized 
series_vec<-c(2,3)
for (ki in 1:length(a_vec)) #ki<-3  
{
# extract all series from first realization (there is only one realization here)
  file = paste("z_dfa_cust_ats_out_",ki,"_ST.pdf", sep = "")
  pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 3)
  xf_per<-xff_sim[940:(940+len),,ki,1]#dim(xff_sim)
  dimnames(xf_per)[[2]]<-dim_names[[1]]
  anf<-1
  enf<-len
  sel<-1:dim(amp)[2]
  mplot<-scale(cbind(xf_per[,series_vec[1]],xf_per[,series_vec[2]])[anf:enf,])  #head(xf_per)
  plot(as.ts(mplot[,1]),type="l",axes=F,col="red",ylim=c(min(na.exclude(mplot)),
  max(na.exclude(mplot))),ylab="",xlab="",
  main=paste("MSE (red) vs. Customized (cyan): a1=",a_vec[ki],sep=""),lwd=1)
  mtext("MSE", side = 3, line = -1,at=(enf-anf)/2,col=colo[1])
  i<-2
  lines(as.ts(mplot[,i]),col=colo[2],lwd=2)
  mtext(paste("Customized: ",dimnames(xf_per)[[2]][series_vec[2]],sep=""), side = 3, line = -i,at=(enf-anf)/2,col=colo[2])
  axis(1,at=c(1,rep(0,6))+as.integer((0:6)*(enf-anf)/6),
  labels=as.integer(anf+(0:6)*(enf-anf)/6))
  axis(2)
  box()
  dev.off()

}


###################################################
### code chunk number 105: z_dfa_cust_ats_out_1_ST.pdf
###################################################
  file = paste("z_dfa_cust_ats_out_1_ST", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=4in]{", file, "}\n",sep = "")
  cat("\\caption{Filter outputs MSE (red) vs. customized (cyan), a1=0.9", sep = "")
  cat("\\label{z_dfa_cust_ats_out_1_ST}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 106: ATS.Rnw:868-871
###################################################
# We allow for a re-calibration (by the inverse amplitude function in the passband)
scaled_ATS<-T
for_sim_obj<-for_sim_out(a_vec,len1,len,cutoff,L,mba,estim_MBA,L_sym,Lag,i1,i2,scaled_ATS,lambda_vec,eta_vec,anzsim)


###################################################
### code chunk number 107: ATS.Rnw:873-883
###################################################
# Extract sample performances
# 1 ATS
ats_sym_ST_re_scaled<-for_sim_obj$ats_sym
# 2. Amplitude and time-shifts
amp_sim_per_re_scaled<-for_sim_obj$amp_sim_per
# 3. Target
Gamma<-for_sim_obj$Gamma
i_process<-1
ats_scaled_unscaled<-rbind(ats_sym_ST[3,,i_process,1],ats_sym_ST_re_scaled[3,,i_process,1])
dimnames(ats_scaled_unscaled)[[1]]<-c("Customized unscaled","Customized re-scaled")


###################################################
### code chunk number 108: ATS.Rnw:888-902
###################################################
DGP<-1
colo<-c("blue","cyan","orange")
passband<-1:(1+(length(amp_sim_per[,1+length(eta_vec),DGP,1])-1)*cutoff/pi)
file = paste("z_box_plot_amp_and_shift_cust_ST_",DGP,"_scaled_unscaled.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 3)
mplot<-cbind(Gamma,amp_sim_per[,1+length(eta_vec),DGP,1],amp_sim_per[,1+length(eta_vec),DGP,1]/mean(amp_sim_per[passband,1+length(eta_vec),DGP,1]))
dimnames(mplot)[[2]]<-c("Target","Amplitude original","Amplitude re-calibrated")
ax<-rep(NA,ncol(mplot))
ax[1+(0:6)*((nrow(mplot)-1)/6)]<-c(0,"pi/6","2pi/6","3pi/6","4pi/6","5pi/6","pi")
plot_title<-"Amplitude customized: original (cyan) vs. re-scaled (orange)"
insamp<-1.e+90
title_more<-dimnames(mplot)[[2]]
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
dev.off()


###################################################
### code chunk number 109: z_box_plot_amp_and_shift_cust_ST_1_scaled_unscaled.pdf
###################################################
  file = paste("z_box_plot_amp_and_shift_cust_ST_1_scaled_unscaled", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=4in, width=4in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude functions of original (cyan) and scaled customized filter (orange)", sep = "")
  cat("\\label{z_box_plot_amp_and_shift_cust_ST_1_scaled_unscaled}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 110: print_tab_cor
###################################################
library(Hmisc)
require(xtable)
#latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
#center = "centering", file = "", floating = FALSE)
xtable(ats_scaled_unscaled, dec = 1,digits=6, caption = paste("ATS-Components of customized design: unscaled vs. scaled filter, a1=0.9",sep=""),label=paste("ats_comp_dfa_ST_1_scaled_unscaled",sep=""),
center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 111: print_tab_cor
###################################################
i_process<-1
library(Hmisc)
require(xtable)
#latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
#center = "centering", file = "", floating = FALSE)
xtable(cbind(ats_sym_T[-1,,i_process,1],amp_shift_mat_sim_T[-1,3:4,i_process,1]), dec = 1,digits=6, caption = paste("ATS-Components, Peak-Correlation and Curvature: emphasizing Timeliness only, a1=0.9",sep=""),label=paste("ats_comp_dfa_T_1_pc",sep=""),
center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 112: print_tab_cor
###################################################
library(Hmisc)
require(xtable)
#latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
#center = "centering", file = "", floating = FALSE)
xtable(cbind(ats_sym_S[-1,,i_process,1],amp_shift_mat_sim_S[-1,3:4,i_process,1]), dec = 1,digits=6, caption = paste("ATS-Components, Peak-Correlation and Curvature: emphasizing Smoothness only, a1=0.9",sep=""),label=paste("ats_comp_dfa_S_1_pc",sep=""),
center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 113: ATS.Rnw:977-979
###################################################
ats_scaled_unscaled_pc<-rbind(cbind(ats_sym_ST[2:3,,i_process,1],amp_shift_mat_sim_ST[-1,3:4,i_process,1]),c(ats_sym_ST_re_scaled[3,,i_process,1],amp_shift_mat_sim_ST[3,3:4,i_process,1]))
dimnames(ats_scaled_unscaled_pc)[[1]][3]<-"Scaled customized"


###################################################
### code chunk number 114: print_tab_cor
###################################################
library(Hmisc)
require(xtable)
#latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
#center = "centering", file = "", floating = FALSE)
xtable(ats_scaled_unscaled_pc, dec = 1,digits=6, caption = paste("ATS-Components, Peak-Correlation and Curvature: emphasizing Timeliness and Smoothness, a1=0.9",sep=""),label=paste("ats_comp_dfa_ST_1_pc",sep=""),
center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 115: ATS.Rnw:1052-1053
###################################################
source(file=paste(path_DFA.pgm,"functions_trilemma.r",sep=""))


###################################################
### code chunk number 116: ATS.Rnw:1057-1059
###################################################
# Number of realizations
anzsim<-100


###################################################
### code chunk number 117: ATS.Rnw:1061-1086
###################################################
# Specify the processes: ar(1) with coefficients -0.9,0 and 0.9
a_vec<-c(0.9,0,-0.9)
# Ordinary ATS-components
scaled_ATS<-F
# Specify the lambdas
lambda_vec<-c(0,0,30,500)
# Specify the etas
eta_vec<-c(0,1.5,1,0.3)
# Specify filter length
L<-24
# Use periodogram
mba<-F
estim_MBA<-T
# Length of symmetric target filter (for computing MSEs)
L_sym<-2*939
# Length of long data
len1<-2000
# Length of estimation sample
len<-120
# cutoff
cutoff<-pi/12
#
Lag<-0
#
i1<-i2<-F


###################################################
### code chunk number 118: ATS.Rnw:1088-1090
###################################################
# Proceed to simulation run
for_sim_obj<-for_sim_out(a_vec,len1,len,cutoff,L,mba,estim_MBA,L_sym,Lag,i1,i2,scaled_ATS,lambda_vec,eta_vec,anzsim)


###################################################
### code chunk number 119: ATS.Rnw:1092-1100
###################################################
# Extract sample performances
amp_shift_mat_sim<-for_sim_obj$amp_shift_mat_sim
amp_sim_per<-for_sim_obj$amp_sim_per
shift_sim_per<-for_sim_obj$shift_sim_per
xff_sim<-for_sim_obj$xff_sim
xff_sim_sym<-for_sim_obj$xff_sim_sym
ats_sym<-for_sim_obj$ats_sym
dim_names<-for_sim_obj$dim_names


###################################################
### code chunk number 120: ATS.Rnw:1113-1140
###################################################
# Boxplots performance measures: curvatures and peak-cor in and out-of-sample

colo<-c("red","orange","yellow","green","blue")#rainbow(length(lambda_vec)+1)

Perf_meas_sel<-c(3,7,4,8,5,9,6,10)
for (DGP in 1:length(a_vec))#DGP<-2
{
  file = paste("z_box_plot_emp_per_perf_inout_",DGP,".pdf", sep = "")
  pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
  par(mfrow=c(2,2))
  for (Perf_meas in Perf_meas_sel[1:4])
  {
    boxplot(list(amp_shift_mat_sim[1,Perf_meas,DGP,],amp_shift_mat_sim[2,Perf_meas,DGP,], amp_shift_mat_sim[3,Perf_meas,DGP,],amp_shift_mat_sim[4,Perf_meas,DGP,],amp_shift_mat_sim[5,Perf_meas,DGP,]),outline=T,names=c("Best MSE",paste("(",lambda_vec,",",eta_vec,")",sep="")),main=paste(dim_names[[2]][Perf_meas],", a1=",a_vec[DGP],sep=""),cex.axis=0.8,col=colo)
  }
  dev.off()
  file = paste("z_box_plot_emp_per_perf_mse_inout_",DGP,".pdf", sep = "")
  pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
  par(mfrow=c(1,2))
  for (Perf_meas in Perf_meas_sel[5:6])
  {
    boxplot(list(amp_shift_mat_sim[1,Perf_meas,DGP,],amp_shift_mat_sim[2,Perf_meas,DGP,],
    amp_shift_mat_sim[3,Perf_meas,DGP,],amp_shift_mat_sim[4,Perf_meas,DGP,],amp_shift_mat_sim[5,Perf_meas,DGP,]),outline=T,
    names=c("Best MSE",paste("(",lambda_vec,",",eta_vec,")",sep="")),
    main=paste(dim_names[[2]][Perf_meas],", a1=",a_vec[DGP],sep=""),cex.axis=0.8,col=colo,notch=F)
  }
  dev.off()
}


###################################################
### code chunk number 121: z_box_plot_emp_per_perf_inout_2.pdf
###################################################
  file = paste("z_box_plot_emp_per_perf_inout_2", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=5in, width=5in]{", file, "}\n",sep = "")
  cat("\\caption{Empirical distributions
  of Curvature and Peak-Correlation of best theoretical MSE (red), empirical MSE (orange), strong noise suppression (yellow), balanced fast and smooth (green) and very fast (blue) filters. All empirical filters are based on the periodogram:
  in-sample (left plots) and out-of-sample (right plots) for a1=0", sep = "")
  cat("\\label{z_box_plot_emp_per_perf_inout_2}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 122: z_box_plot_emp_per_perf_mse_inout_2.pdf
###################################################
  file = paste("z_box_plot_emp_per_perf_mse_inout_2", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=2.5in, width=5in]{", file, "}\n",sep = "")
  cat("\\caption{Empirical distributions
  of Sample MSEs of best theoretical MSE (red), empirical MSE (orange), strong noise suppression (yellow), balanced fast and speed (green) and very fast (blue) filters. All empirical filters are based on the periodogram:
  in-sample (left plots) and out-of-sample (right plots) for a1=0", sep = "")
  cat("\\label{z_box_plot_emp_per_perf_mse_inout_2}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 123: ATS.Rnw:1186-1221
###################################################
amp_shift_mat_sim<-for_sim_obj$amp_shift_mat_sim
amp_sim_per<-for_sim_obj$amp_sim_per
shift_sim_per<-for_sim_obj$shift_sim_per
xff_sim<-for_sim_obj$xff_sim
xff_sim_sym<-for_sim_obj$xff_sim_sym
ats_sym<-for_sim_obj$ats_sym
dim_names<-for_sim_obj$dim_names
for (ki in 2:2) #ki<-2  
{
file = paste("z_dfa_cust_ats_mba_per_e.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)

  xf_per<-xff_sim[940:(940+2*len),,ki,10]
  dimnames(xf_per)[[2]]<-dim_names[[1]]
  anf<-1
  enf<-2*len
  sel<-1:dim(amp)[2]
  mplot<-scale(cbind(xf_per[,1],xf_per[,4])[anf:enf,])  #head(xf_per)
  plot(as.ts(mplot[,1]),type="l",axes=F,col="red",ylim=c(min(na.exclude(mplot)),
  max(na.exclude(mplot))),ylab="",xlab="",
  main=paste("Benchmark MSE (red) vs. Customized balanced (green)",sep=""),lwd=2)
  mtext("in sample",side = 3, line = -1,at=60,col="black")
  mtext("out-of-sample",side = 3, line = -1,at=180,col="black")
  mtext("Benchmark MSE", side = 3, line = -1,at=(enf-anf)/2,col="red")
  i<-2
  lines(as.ts(mplot[,i]),col=colo[4],lwd=2)
  mtext(paste("Customized: ",dimnames(xf_per)[[2]][4],sep=""), side = 3, line = -i,at=(enf-anf)/2,col=colo[4])
  abline(v=120)
  axis(1,at=c(1,rep(0,6))+as.integer((0:6)*(enf-anf)/6),
  labels=as.integer(anf+(0:6)*(enf-anf)/6))
  axis(2)
  box()

dev.off()
}


###################################################
### code chunk number 124: z_dfa_cust_ats_mba_per_e.pdf
###################################################
  file = paste("z_dfa_cust_ats_mba_per_e", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=4in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Outputs of benchmark MSE (red) and customized balanced (green) filters: a1=0. In-sample (left half) and out-of-sample (right half)", sep = "")
  cat("\\label{z_dfa_cust_ats_mba_per_e}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")



###################################################
### code chunk number 125: ATS.Rnw:1252-1257
###################################################
# white noise
a1<-0.
# Customization settings DFA
lambda_vec<-c(0,30)
eta_vec<-c(0,1)


###################################################
### code chunk number 126: ATS.Rnw:1259-1268
###################################################
# target
cutoff<-pi/12
len1<-2000
len<-120
L<-24
Lag<-0
i1<-i2<-F
# MDFA: MSE design
lambda_mdfa<-eta_mdfa<-0


###################################################
### code chunk number 127: ATS.Rnw:1270-1272
###################################################
# Run the competition: the new function handles the multivariate case
cust_leading_obj<-mdfa_mse_leading_indicator_vs_dfa_customized(anzsim,a1,cutoff,L,lambda_vec,eta_vec,len1,len,i1,i2,Lag,lambda_mdfa,eta_mdfa)  


###################################################
### code chunk number 128: ATS.Rnw:1280-1287
###################################################
file = paste("z_curv_dfacust_leadind.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(1,2))
boxplot(list(cust_leading_obj$perf_in_sample[,1,1],cust_leading_obj$perf_in_sample[,1,2],cust_leading_obj$perf_in_sample[,1,3]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),"MDFA-MSE Leading Indicator"),main=paste("Curvature in-sample, a1=",a1,sep=""),cex.axis=0.8,col=c("orange","green","brown"))

boxplot(list(cust_leading_obj$perf_out_sample[,1,1],cust_leading_obj$perf_out_sample[,1,2],cust_leading_obj$perf_out_sample[,1,3]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),"MDFA-MSE Leading Indicator"),main=paste("Curvature out-of-sample, a1=",a1,sep=""),cex.axis=0.8,col=c("orange","green","brown"))
dev.off()


###################################################
### code chunk number 129: z_curv_dfacust_leadind.pdf
###################################################
  file = paste("z_curv_dfacust_leadind", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=4in]{", file, "}\n",sep = "")
  cat("\\caption{Curvature: mean-square DFA (orange), customized DFA (green) and MSE-MDFA leading indicator (brown): a1=0. In-sample (left) and out-of-sample (right).", sep = "")
  cat("\\label{z_curv_dfacust_leadind}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 130: ATS.Rnw:1307-1316
###################################################
file = paste("z_peak_cor_dfacust_leadind.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)

par(mfrow=c(1,2))
boxplot(list(cust_leading_obj$perf_in_sample[,2,1],cust_leading_obj$perf_in_sample[,2,2],cust_leading_obj$perf_in_sample[,2,3]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),"MDFA-MSE Leading Indicator"),main=paste("Peak-Correlation in-sample, a1=",a1,sep=""),cex.axis=0.8,col=c("orange","green","brown"))

boxplot(list(cust_leading_obj$perf_out_sample[,2,1],cust_leading_obj$perf_out_sample[,2,2],cust_leading_obj$perf_out_sample[,2,3]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),"MDFA-MSE Leading Indicator"),main=paste("Peak-Correlation out-of-sample, a1=",a1,sep=""),cex.axis=0.8,col=c("orange","green","brown"))

dev.off()


###################################################
### code chunk number 131: z_peak_cor_dfacust_leadind.pdf
###################################################
  file = paste("z_peak_cor_dfacust_leadind", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=4in]{", file, "}\n",sep = "")
  cat("\\caption{Peak Correlation: mean-square DFA (orange), customized DFA (green) and MSE-MDFA leading indicator (brown): a1=0. In-sample (left) and out-of-sample (right).", sep = "")
  cat("\\label{z_peak_cor_dfacust_leadind}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 132: ATS.Rnw:1337-1344
###################################################
file = paste("z_MSE_dfacust_leadind.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(1,2))
boxplot(list(cust_leading_obj$perf_in_sample[,3,1],cust_leading_obj$perf_in_sample[,3,2],cust_leading_obj$perf_in_sample[,3,3]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),"MDFA-MSE Leading Indicator"),main=paste("MSE in-sample, a1=",a1,sep=""),cex.axis=0.8,col=c("orange","green","brown"))

boxplot(list(cust_leading_obj$perf_out_sample[,3,1],cust_leading_obj$perf_out_sample[,3,2],cust_leading_obj$perf_out_sample[,3,3]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),"MDFA-MSE Leading Indicator"),main=paste("MSE out-of-sample, a1=",a1,sep=""),cex.axis=0.8,col=c("orange","green","brown"))
dev.off()


###################################################
### code chunk number 133: z_MSE_dfacust_leadind.pdf
###################################################
  file = paste("z_MSE_dfacust_leadind", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=4in]{", file, "}\n",sep = "")
  cat("\\caption{MSE: mean-square DFA (orange), customized DFA (green) and MSE-MDFA leading indicator (brown): a1=0. In-sample (left) and out-of-sample (right).", sep = "")
  cat("\\label{z_MSE_dfacust_leadind}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")



###################################################
### code chunk number 134: ATS.Rnw:1366-1385
###################################################
# Plots
file = paste("z_dfa_cust_mdfa_leading_indicator.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
mplot<-scale(cust_leading_obj$filter_output_in_sample) 
dimnames(mplot)[[2]]<-dimnames(cust_leading_obj$filter_output_in_sample)[[2]]
colo_cust<-c("orange","green","brown")
plot(as.ts(mplot[,1]),type="l",axes=F,col=colo_cust[1],ylim=c(min(na.exclude(mplot)),max(na.exclude(mplot))),ylab="",xlab="",main=paste("Filter outputs: last realization",sep=""),lwd=1)
mtext(dimnames(mplot)[[2]][1], side = 3, line = -1,at=nrow(mplot)/2,col=colo_cust[1])
for (i in 2:(ncol(mplot)-1))
{
  lines(mplot[,i],col=colo_cust[i],lwd=1)
  mtext(dimnames(mplot)[[2]][i], side = 3, line = -i,at=nrow(mplot)/2,col=colo_cust[i])
}
axis(1,at=c(1,rep(0,6))+as.integer((0:6)*nrow(mplot)/6),
labels=c(1,rep(0,6))+as.integer((0:6)*nrow(mplot)/6))
axis(2)
box()
dev.off()



###################################################
### code chunk number 135: z_dfa_cust_mdfa_leading_indicator.pdf
###################################################
  file = paste("z_dfa_cust_mdfa_leading_indicator", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=4in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Scaled outputs of DFA-MSE (orange), DFA-balanced (green) and bivariate MDFA-MSE (brown): a1=0.9", sep = "")
  cat("\\label{z_dfa_cust_mdfa_leading_indicator}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")



###################################################
### code chunk number 136: dfa_ms
###################################################
head(mdfa_analytic)


###################################################
### code chunk number 137: ATS_multivariate.Rnw:209-228
###################################################
# white noise
a1<-0.
# Customization settings MDFA
eta_mdfa<-0.3*(0:6)
# Fix lambda=0
lambda_mdfa<-rep(0,length(eta_mdfa))
# Customization settings DFA
lambda_vec<-lambda_vec
eta_vec<-eta_vec
# target
cutoff<-pi/6
# Filter length
L<-12
# Real-time design
Lag<-0
# No constraints
i1<-i2<-F
# Sample length 120
len<-120


###################################################
### code chunk number 138: ATS_multivariate.Rnw:230-234
###################################################
anzsim<-1
lambda_vec<-c(0,30)
eta_vec<-c(0,1)
len1<-2000


###################################################
### code chunk number 139: ATS_multivariate.Rnw:236-237
###################################################
cust_leading_obj<-mdfa_mse_leading_indicator_vs_dfa_customized(anzsim,a1,cutoff,L,lambda_vec,eta_vec,len1,len,i1,i2,Lag,lambda_mdfa,eta_mdfa)  


###################################################
### code chunk number 140: ATS_multivariate.Rnw:244-245
###################################################
tail(mdfa_analytic)


###################################################
### code chunk number 141: ATS_multivariate.Rnw:248-259
###################################################
ats_mat<-matrix(nrow=length(lambda_mdfa),ncol=5)
for (i in 1:length(lambda_mdfa))
{
  ats_mat[i,1]<-cust_leading_obj$mdfa_list[[i]]$Accuracy
  ats_mat[i,2]<-cust_leading_obj$mdfa_list[[i]]$Timeliness
  ats_mat[i,3]<-cust_leading_obj$mdfa_list[[i]]$Smoothness
  ats_mat[i,4]<-0
  ats_mat[i,5]<-sum(ats_mat[i,1:4])
}
dimnames(ats_mat)[[1]]<-paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")
dimnames(ats_mat)[[2]]<-c("Accuracy","Timeliness","Smoothness","Residual","MSE")


###################################################
### code chunk number 142: ats_comp_mdfa_S
###################################################
library(Hmisc)
require(xtable)
#latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
#center = "centering", file = "", floating = FALSE)
xtable(ats_mat, dec = 1,digits=6, caption = paste("ATS-Components as a function of eta (lambda=0 fixed)",sep=""),label=paste("ats_comp_mdfa_S",sep=""),
center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 143: ATS_multivariate.Rnw:277-415
###################################################
colo<-rainbow(length(lambda_mdfa))
file = paste("z_amp_shift_mdfacust_leadind_S.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(3,2))
for (i_mdfa in 1:length(lambda_mdfa))
{

# amplitude functions first series
  if (i_mdfa==1)
  {
    mplot <- abs(cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,1])
  } else
  {
    mplot <- cbind(mplot,abs(cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,1]))
  }
}
dimnames(mplot)[[2]]<-paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")
# x-axis
K<-nrow(mplot)-1
freq_axe <- rep(NA, K + 1)
freq_axe[1] <- 0
freq_axe[1 + (1 : 6) * K / 6] <- c(paste0(c("", 2 : 5), "pi/6"), "pi")
ax <- freq_axe
# colors, title and additional titles
insamp <- 1.e+90
#colo <- NULL
plot_title <- "Amplitude Functions series 1"
title_more <- colnames(mplot)
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)

for (i_mdfa in 1:length(lambda_mdfa))
{

# amplitude functions second series
  if (i_mdfa==1)
  {
    mplot <- abs(cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,2])
  } else
  {
    mplot <- cbind(mplot,abs(cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,2]))
  }
}
dimnames(mplot)[[2]]<-paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")
# x-axis
K<-nrow(mplot)-1
freq_axe <- rep(NA, K + 1)
freq_axe[1] <- 0
freq_axe[1 + (1 : 6) * K / 6] <- c(paste0(c("", 2 : 5), "pi/6"), "pi")
ax <- freq_axe
# colors, title and additional titles
insamp <- 1.e+90
#colo <- NULL
plot_title <- "Amplitude Functions series 2 (leading indicator)"
title_more <- colnames(mplot)
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)


# time-shift first series
for (i_mdfa in 1:length(lambda_mdfa))#i_mdfa<-1  i_mdfa<-7
{

# time-shift functions first series
  if (i_mdfa==1)
  {
    mplot <- Arg(t(sign(apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b,2,sum))*t(cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt)))[,1]/((0 : K) * pi / K)
# Use exact formula in frequency zero    
    mplot[1] <- (apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b * ((0 : (L - 1))), 2, sum) / 
      apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b, 2, sum))[1]

  } else
  {
    mplot <- cbind(mplot,(Arg(t(sign(apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b,2,sum))*t(cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt)))[,1]/((0 : K) * pi / K)))
# Use exact formula in frequency zero    
    mplot[1,i_mdfa] <- (apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b * ((0 : (L - 1))), 2, sum) / 
      apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b, 2, sum))[1]
  }
}
plot_title <- "Time-Shift series 1"
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)


# time-shift second series
for (i_mdfa in 1:length(lambda_mdfa))
{

# time-shift functions second series
  if (i_mdfa==1)
  {
    mplot <- Arg(t(sign(apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b,2,sum))*t(cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt)))[,2]/((0 : K) * pi / K)
# Use exact formula in frequency zero    
    mplot[1] <- (apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b * ((0 : (L - 1))), 2, sum) / 
      apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b, 2, sum))[2]

  } else
  {
    mplot <- cbind(mplot,(Arg(t(sign(apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b,2,sum))*t(cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt)))[,2]/((0 : K) * pi / K)))
# Use exact formula in frequency zero    
    mplot[1,i_mdfa] <- (apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b * ((0 : (L - 1))), 2, sum) / 
      apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b, 2, sum))[2]
  }
}
plot_title <- "Time-Shift series 2 (leading indicator)"
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)

# Filter coefficients
for (i_mdfa in 1:length(lambda_mdfa))
{

# coefficients first series
  if (i_mdfa==1)
  {
    mplot <- cust_leading_obj$mdfa_list[[i_mdfa]]$b[,1]
  } else
  {
    mplot <- cbind(mplot,cust_leading_obj$mdfa_list[[i_mdfa]]$b[,1])
  }
}
plot_title <- "Coefficients series 1"
ax<-paste("Lag ",0:(L-1),sep="")
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)
for (i_mdfa in 1:length(lambda_mdfa))
{

# coefficients first series
  if (i_mdfa==1)
  {
    mplot <- cust_leading_obj$mdfa_list[[i_mdfa]]$b[,2]
  } else
  {
    mplot <- cbind(mplot,cust_leading_obj$mdfa_list[[i_mdfa]]$b[,2])
  }
}
plot_title <- "Coefficents series 2 (leading indicator)"
ax<-paste("Lag ",0:(L-1),sep="")
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)


dev.off()


###################################################
### code chunk number 144: z_amp_shift_mdfacust_leadind_S.pdf
###################################################
  file = paste("z_amp_shift_mdfacust_leadind_S", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=8in, width=5in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (top), time-shift functions (middle) and filter coefficients (bottom): series 1 (left) and series 2 (right) for customized MDFA-leading indicator (emphasizing Smoothness): a1=0.", sep = "")
  cat("\\label{z_amp_shift_mdfacust_leadind_S}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 145: ATS_multivariate.Rnw:439-502
###################################################
colo<-rainbow(length(lambda_mdfa))
file = paste("z_amp_shift_mdfacust_leadind_agg_S.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(1,2))


for (i_mdfa in 1:length(lambda_mdfa))
{

  trffkt_agg<-cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,1]+cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,2]*cust_leading_obj$weight_func[,3]/cust_leading_obj$weight_func[,2]

# amplitude functions first series
  if (i_mdfa==1)
  {
    mplot <- abs(trffkt_agg)
  } else
  {
    mplot <- cbind(mplot,abs(trffkt_agg))
  }
}
mplot[1,]<-NA
dimnames(mplot)[[2]]<-paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")
# x-axis
K<-nrow(mplot)-1
freq_axe <- rep(NA, K + 1)
freq_axe[1] <- 0
freq_axe[1 + (1 : 6) * K / 6] <- c(paste0(c("", 2 : 5), "pi/6"), "pi")
ax <- freq_axe
# colors, title and additional titles
insamp <- 1.e+90
#colo <- NULL
plot_title <- "Amplitude aggregated filter"
title_more <- colnames(mplot)
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)



# time-shift first series
for (i_mdfa in 1:length(lambda_mdfa))#i_mdfa<-1  i_mdfa<-7
{  
  trffkt_agg<-cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,1]+cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,2]*cust_leading_obj$weight_func[,3]/cust_leading_obj$weight_func[,2]


# time-shift functions first series
  if (i_mdfa==1)
  {
    mplot <- Arg(trffkt_agg)/((0 : K) * pi / K)
# Use exact formula in frequency zero    
  #  mplot[1] <- (apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b * ((0 : (L - 1))), 2, sum) / 
   #   apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b, 2, sum))[1]

  } else
  {
    mplot <- cbind(mplot, Arg(trffkt_agg)/((0 : K) * pi / K))
# Use exact formula in frequency zero    
    #mplot[1,i_mdfa] <- (apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b * ((0 : (L - 1))), 2, sum) / 
     # apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b, 2, sum))[1]
  }
}
plot_title <- "Time-Shift aggregated filter"
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)

dev.off()


###################################################
### code chunk number 146: z_amp_shift_mdfacust_leadind_agg_S.pdf
###################################################
  file = paste("z_amp_shift_mdfacust_leadind_agg_S", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (left) and time-shift functions (right) of aggregated filter when emphasizing Smoothness: a1=0.", sep = "")
  cat("\\label{z_amp_shift_mdfacust_leadind_agg_S}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 147: ATS_multivariate.Rnw:529-533
###################################################
# Customization settings DFA
lambda_mdfa<-c(0,2^(0:7))
# Fix eta=0
eta_mdfa<-rep(0,length(lambda_mdfa))


###################################################
### code chunk number 148: ATS_multivariate.Rnw:535-551
###################################################
# white noise
a1<-0.
# target
cutoff<-pi/6
# Filter length
L<-12
# Real-time design
Lag<-0
# No constraints
i1<-i2<-F
# Sample length 120
len<-120
anzsim<-1
lambda_vec<-c(0,30)
eta_vec<-c(0,1)
len1<-2000


###################################################
### code chunk number 149: ATS_multivariate.Rnw:553-554
###################################################
cust_leading_obj<-mdfa_mse_leading_indicator_vs_dfa_customized(anzsim,a1,cutoff,L,lambda_vec,eta_vec,len1,len,i1,i2,Lag,lambda_mdfa,eta_mdfa)  


###################################################
### code chunk number 150: ATS_multivariate.Rnw:562-573
###################################################
ats_mat<-matrix(nrow=length(lambda_mdfa),ncol=5)
for (i in 1:length(lambda_mdfa))
{
  ats_mat[i,1]<-cust_leading_obj$mdfa_list[[i]]$Accuracy
  ats_mat[i,2]<-cust_leading_obj$mdfa_list[[i]]$Timeliness
  ats_mat[i,3]<-cust_leading_obj$mdfa_list[[i]]$Smoothness
  ats_mat[i,4]<-0
  ats_mat[i,5]<-sum(ats_mat[i,1:4])
}
dimnames(ats_mat)[[1]]<-paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")
dimnames(ats_mat)[[2]]<-c("Accuracy","Timeliness","Smoothness","Residual","MSE")


###################################################
### code chunk number 151: ats_comp_mdfa_T
###################################################
library(Hmisc)
require(xtable)
#latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
#center = "centering", file = "", floating = FALSE)
xtable(ats_mat, dec = 1,digits=6, caption = paste("ATS-Components as a function of lambda (eta=0 fixed)",sep=""),label=paste("ats_comp_mdfa_T",sep=""),
center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 152: ATS_multivariate.Rnw:592-655
###################################################
colo<-rainbow(length(lambda_mdfa))
file = paste("z_amp_shift_mdfacust_leadind_agg_T.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(1,2))


for (i_mdfa in 1:length(lambda_mdfa))
{

  trffkt_agg<-cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,1]+cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,2]*cust_leading_obj$weight_func[,3]/cust_leading_obj$weight_func[,2]

# amplitude functions first series
  if (i_mdfa==1)
  {
    mplot <- abs(trffkt_agg)
  } else
  {
    mplot <- cbind(mplot,abs(trffkt_agg))
  }
}
mplot[1,]<-NA
dimnames(mplot)[[2]]<-paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")
# x-axis
K<-nrow(mplot)-1
freq_axe <- rep(NA, K + 1)
freq_axe[1] <- 0
freq_axe[1 + (1 : 6) * K / 6] <- c(paste0(c("", 2 : 5), "pi/6"), "pi")
ax <- freq_axe
# colors, title and additional titles
insamp <- 1.e+90
#colo <- NULL
plot_title <- "Amplitude aggregated filter"
title_more <- colnames(mplot)
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)



# time-shift first series
for (i_mdfa in 1:length(lambda_mdfa))#i_mdfa<-1  i_mdfa<-7
{  
  trffkt_agg<-cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,1]+cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,2]*cust_leading_obj$weight_func[,3]/cust_leading_obj$weight_func[,2]


# time-shift functions first series
  if (i_mdfa==1)
  {
    mplot <- Arg(trffkt_agg)/((0 : K) * pi / K)
# Use exact formula in frequency zero    
  #  mplot[1] <- (apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b * ((0 : (L - 1))), 2, sum) / 
   #   apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b, 2, sum))[1]

  } else
  {
    mplot <- cbind(mplot, Arg(trffkt_agg)/((0 : K) * pi / K))
# Use exact formula in frequency zero    
    #mplot[1,i_mdfa] <- (apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b * ((0 : (L - 1))), 2, sum) / 
     # apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b, 2, sum))[1]
  }
}
plot_title <- "Time-Shift aggregated filter"
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)

dev.off()


###################################################
### code chunk number 153: z_amp_shift_mdfacust_leadind_agg_T.pdf
###################################################
  file = paste("z_amp_shift_mdfacust_leadind_agg_T", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (left) and time-shift functions (right) of aggregated filter when emphasizing Timeliness: a1=0.", sep = "")
  cat("\\label{z_amp_shift_mdfacust_leadind_agg_T}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 154: ATS_multivariate.Rnw:682-686
###################################################
# Customization settings DFA
lambda_mdfa<-c(0,30)
# Fix eta=0
eta_mdfa<-c(0,1)


###################################################
### code chunk number 155: ATS_multivariate.Rnw:688-704
###################################################
# white noise
a1<-0.
# target
cutoff<-pi/6
# Filter length
L<-12
# Real-time design
Lag<-0
# No constraints
i1<-i2<-F
# Sample length 120
len<-120
anzsim<-1
lambda_vec<-c(0,30)
eta_vec<-c(0,1)
len1<-2000


###################################################
### code chunk number 156: ATS_multivariate.Rnw:706-707
###################################################
cust_leading_obj<-mdfa_mse_leading_indicator_vs_dfa_customized(anzsim,a1,cutoff,L,lambda_vec,eta_vec,len1,len,i1,i2,Lag,lambda_mdfa,eta_mdfa)  


###################################################
### code chunk number 157: ATS_multivariate.Rnw:714-725
###################################################
ats_mat<-matrix(nrow=length(lambda_mdfa),ncol=5)
for (i in 1:length(lambda_mdfa))
{
  ats_mat[i,1]<-cust_leading_obj$mdfa_list[[i]]$Accuracy
  ats_mat[i,2]<-cust_leading_obj$mdfa_list[[i]]$Timeliness
  ats_mat[i,3]<-cust_leading_obj$mdfa_list[[i]]$Smoothness
  ats_mat[i,4]<-0
  ats_mat[i,5]<-sum(ats_mat[i,1:4])
}
dimnames(ats_mat)[[1]]<-paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")
dimnames(ats_mat)[[2]]<-c("Accuracy","Timeliness","Smoothness","Residual","MSE")


###################################################
### code chunk number 158: ats_comp_mdfa_ST
###################################################
library(Hmisc)
require(xtable)
#latex(cor_vec, dec = 1, , caption = "Example of using latex to create table",
#center = "centering", file = "", floating = FALSE)
xtable(ats_mat, dec = 1,digits=6, caption = paste("ATS-Components as a function of lambda and eta",sep=""),label=paste("ats_comp_mdfa_ST",sep=""),
center = "centering", file = "", floating = FALSE)


###################################################
### code chunk number 159: ATS_multivariate.Rnw:744-808
###################################################
colo<-rainbow(length(lambda_mdfa)+length(lambda_vec))[length(lambda_vec)+1:length(lambda_mdfa)]
file = paste("z_amp_shift_mdfacust_leadind_agg_ST.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(1,2))


for (i_mdfa in 1:length(lambda_mdfa))
{

  trffkt_agg<-cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,1]+cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,2]*cust_leading_obj$weight_func[,3]/cust_leading_obj$weight_func[,2]

# amplitude functions first series
  if (i_mdfa==1)
  {
    mplot <- abs(trffkt_agg)
  } else
  {
# We scale the customized filter because of zero-shrinkage    
    mplot <- cbind(mplot,abs(trffkt_agg)*0.8*mean(mplot[2:12])/mean(abs(trffkt_agg)[2:12]))
  }
}
mplot[1,]<-NA
dimnames(mplot)[[2]]<-paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")
# x-axis
K<-nrow(mplot)-1
freq_axe <- rep(NA, K + 1)
freq_axe[1] <- 0
freq_axe[1 + (1 : 6) * K / 6] <- c(paste0(c("", 2 : 5), "pi/6"), "pi")
ax <- freq_axe
# colors, title and additional titles
insamp <- 1.e+90
#colo <- NULL
plot_title <- "Amplitude aggregated filter"
title_more <- colnames(mplot)
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)



# time-shift first series
for (i_mdfa in 1:length(lambda_mdfa))#i_mdfa<-1  i_mdfa<-7
{  
  trffkt_agg<-cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,1]+cust_leading_obj$mdfa_list[[i_mdfa]]$trffkt[,2]*cust_leading_obj$weight_func[,3]/cust_leading_obj$weight_func[,2]


# time-shift functions first series
  if (i_mdfa==1)
  {
    mplot <- Arg(trffkt_agg)/((0 : K) * pi / K)
# Use exact formula in frequency zero    
  #  mplot[1] <- (apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b * ((0 : (L - 1))), 2, sum) / 
   #   apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b, 2, sum))[1]

  } else
  {
    mplot <- cbind(mplot, Arg(trffkt_agg)/((0 : K) * pi / K))
# Use exact formula in frequency zero    
    #mplot[1,i_mdfa] <- (apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b * ((0 : (L - 1))), 2, sum) / 
     # apply(cust_leading_obj$mdfa_list[[i_mdfa]]$b, 2, sum))[1]
  }
}
plot_title <- "Time-Shift aggregated filter"
mplot_func(mplot, ax, plot_title, title_more, insamp, colo)

dev.off()


###################################################
### code chunk number 160: z_amp_shift_mdfacust_leadind_agg_ST.pdf
###################################################
  file = paste("z_amp_shift_mdfacust_leadind_agg_ST", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Amplitude (left) and time-shift functions (right) of aggregated filter when emphasizing Timeliness: a1=0.", sep = "")
  cat("\\label{z_amp_shift_mdfacust_leadind_agg_ST}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 161: ATS_multivariate.Rnw:832-852
###################################################
# Customization MDFA: MSE and balanced designs
lambda_mdfa<-c(0,30)
eta_mdfa<-c(0,1.)
# Customization DFA: MSE and balanced designs
lambda_vec<-c(0,30)
eta_vec<-c(0,1)
# white noise
a1<-0.
# target
cutoff<-pi/6
# Filter length
L<-12
# Real-time design
Lag<-0
# No constraints
i1<-i2<-F
# Sample length 120
len<-120
# Number of replications
anzsim<-100


###################################################
### code chunk number 162: ATS_multivariate.Rnw:854-855
###################################################
len1<-2000


###################################################
### code chunk number 163: ATS_multivariate.Rnw:857-858
###################################################
cust_leading_obj<-mdfa_mse_leading_indicator_vs_dfa_customized(anzsim,a1,cutoff,L,lambda_vec,eta_vec,len1,len,i1,i2,Lag,lambda_mdfa,eta_mdfa)  


###################################################
### code chunk number 164: ATS_multivariate.Rnw:863-880
###################################################
colo<-rainbow(length(lambda_mdfa)+length(lambda_vec))
file = paste("z_curv_mdfacust_leadind_ST.pdf", sep = "")
pdf(file = paste(path.out,file,sep=""), paper = "special", width = 6, height = 6)
par(mfrow=c(3,2))
# Curvature in sample  dim(cust_leading_obj$perf_in_sample)
boxplot(list(cust_leading_obj$perf_in_sample[,1,1],cust_leading_obj$perf_in_sample[,1,2],cust_leading_obj$perf_in_sample[,1,3],cust_leading_obj$perf_in_sample[,1,4]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")),main=paste("Curvature in-sample, a1=",a1,sep=""),cex.axis=0.8,col=colo)
# Curvature out-of-sample
boxplot(list(cust_leading_obj$perf_out_sample[,1,1],cust_leading_obj$perf_out_sample[,1,2],cust_leading_obj$perf_out_sample[,1,3],cust_leading_obj$perf_out_sample[,1,4]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")),main=paste("Curvature out-of-sample, a1=",a1,sep=""),cex.axis=0.8,col=colo)
# Peak correlation in sample
boxplot(list(cust_leading_obj$perf_in_sample[,2,1],cust_leading_obj$perf_in_sample[,2,2],cust_leading_obj$perf_in_sample[,2,3],cust_leading_obj$perf_in_sample[,2,4]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")),main=paste("Peak Correlation in-sample, a1=",a1,sep=""),cex.axis=0.8,col=colo)
# Peak correlation out-of-sample 
boxplot(list(cust_leading_obj$perf_out_sample[,2,1],cust_leading_obj$perf_out_sample[,2,2],cust_leading_obj$perf_out_sample[,2,3],cust_leading_obj$perf_out_sample[,2,4]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")),main=paste("Peak Correlation out-of-sample, a1=",a1,sep=""),cex.axis=0.8,col=colo)
# MSE in sample
boxplot(list(cust_leading_obj$perf_in_sample[,3,1],cust_leading_obj$perf_in_sample[,3,2],cust_leading_obj$perf_in_sample[,3,3],cust_leading_obj$perf_in_sample[,3,4]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")),main=paste("MSE in-sample, a1=",a1,sep=""),cex.axis=0.8,col=colo)
# MSE out-of-sample 
boxplot(list(cust_leading_obj$perf_out_sample[,3,1],cust_leading_obj$perf_out_sample[,3,2],cust_leading_obj$perf_out_sample[,3,3],cust_leading_obj$perf_out_sample[,3,4]),outline=T,names=c(paste("DFA(",lambda_vec,",",eta_vec,")",sep=""),paste("MDFA(",lambda_mdfa,",",eta_mdfa,")",sep="")),main=paste("MSE out-of-sample, a1=",a1,sep=""),cex.axis=0.8,col=colo)
dev.off()


###################################################
### code chunk number 165: z_curv_mdfacust_leadind_ST.pdf
###################################################
  file = paste("z_curv_mdfacust_leadind_ST", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=7in, width=5in]{", file, "}\n",sep = "")
  cat("\\caption{Curvature (top), Peak Correlation (middle) and MSE (bottom), in-sample (left) and out-of-sample (right) for MSE-DFA (red), balanced DFA (green), MSE-MDFA (cyan) and balanced MDFA (violet): a1=0.", sep = "")
  cat("\\label{z_curv_mdfacust_leadind_ST}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 166: z_box_plot_emp_per_perf_inout_1.pdf
###################################################
  file = paste("z_box_plot_emp_per_perf_inout_1", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Empirical distributions
  of Curvature and Peak-Correlation of best theoretical MSE (red), empirical MSE (yellow), balanced customized (green),
  unbalanced smoothness (cyan) and unbalanced timeliness (blue) filters. All empirical filters are based on the periodogram:
  in-sample (left plots) and out-of-sample (right plots) for a1=-0.9", sep = "")
  cat("\\label{z_box_plot_emp_per_perf_inout_1}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 167: z_box_plot_emp_per_perf_mse_inout_1.pdf
###################################################
  file = paste("z_box_plot_emp_per_perf_mse_inout_1", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Empirical distributions
  of Sample MSEs of best theoretical MSE (red), empirical MSE (yellow), balanced customized (green),
  unbalanced smoothness (cyan) and unbalanced timeliness (blue) filters. All empirical filters are based on the periodogram:
  in-sample (left plots) and out-of-sample (right plots) for a1=-0.9", sep = "")
  cat("\\label{z_box_plot_emp_per_perf_mse_inout_1}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 168: z_box_plot_emp_per_perf_inout_3.pdf
###################################################
  file = paste("z_box_plot_emp_per_perf_inout_3", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=6in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Empirical distributions
  of Curvature and Peak-Correlation of best theoretical MSE (red), empirical MSE (yellow), balanced customized (green),
  unbalanced smoothness (cyan) and unbalanced timeliness (blue) filters. All empirical filters are based on the periodogram:
  in-sample (left plots) and out-of-sample (right plots) for a1=0.9", sep = "")
  cat("\\label{z_box_plot_emp_per_perf_inout_3}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


###################################################
### code chunk number 169: z_box_plot_emp_per_perf_mse_inout_3.pdf
###################################################
  file = paste("z_box_plot_emp_per_perf_mse_inout_3", sep = "")
  cat("\\begin{figure}[H]")
  cat("\\begin{center}")
  cat("\\includegraphics[height=3in, width=6in]{", file, "}\n",sep = "")
  cat("\\caption{Empirical distributions
  of  Sample MSEs of best theoretical MSE (red), empirical MSE (yellow), balanced customized (green),
  unbalanced smoothness (cyan) and unbalanced timeliness (blue) filters. All empirical filters are based on the periodogram:
  in-sample (left plots) and out-of-sample (right plots) for a1=0.9", sep = "")
  cat("\\label{z_box_plot_emp_per_perf_mse_inout_3}}", sep = "")
  cat("\\end{center}")
  cat("\\end{figure}")


